<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#00FFE7" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Son1kVers3" />
  <link rel="manifest" href="/manifest.json" />
  <title>Son1kVers3 — La Resistencia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { 
            neon: '#00FFE7', 
            coal: '#0B0B0F', 
            haze: '#0f111a',
            'neon-purple': '#8b5cf6',
            'neon-blue': '#06b6d4' 
          },
          boxShadow: { glow: '0 0 40px rgba(0,255,231,.25)' }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: #0f111a !important; height: 100%; }
    body { background: #0f111a !important; color: #e4e4e7 !important; font-family: Inter, ui-sans-serif, system-ui !important; min-height: 100vh; }
    
    /* Layout System */
    .app-container {
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 1.5rem;
      padding: 1rem;
      min-height: calc(100vh - 80px);
    }
    
    .sidebar { 
      background: rgba(15, 17, 26, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      height: fit-content;
      position: sticky;
      top: 1rem;
    }
    
    .main-content {
      background: rgba(15, 17, 26, 0.9);
      border: 1px solid rgba(0, 255, 231, 0.2);
      border-radius: 16px;
      padding: 2rem;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 30px rgba(0, 255, 231, 0.1);
      min-height: 600px;
    }
    
    /* Navigation */
    .nav-bar {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
    }
    
    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e4e4e7;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }
    
    .nav-tab:hover {
      background: rgba(0, 255, 231, 0.1);
      border-color: rgba(0, 255, 231, 0.3);
    }
    
    .nav-tab.active {
      background: linear-gradient(45deg, #00FFE7, #8b5cf6);
      color: #000;
      border-color: #00FFE7;
    }
    
    /* Controls */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    
    .control-item {
      text-align: center;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .knob { 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      position: relative; 
      background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      cursor: pointer; 
      transition: all 0.2s ease;
      border: 3px solid #333;
      margin: 0 auto 0.5rem;
    }
    
    .knob:hover { 
      transform: scale(1.05); 
      box-shadow: 0 0 20px rgba(0,255,231,.3); 
    }
    
    .knob::after { 
      content: ''; 
      position: absolute; 
      left: 50%; 
      top: 10px; 
      width: 4px; 
      height: 20px; 
      background: #00FFE7; 
      border-radius: 2px; 
      transform: translateX(-50%) rotate(var(--rotation, 0deg)); 
      box-shadow: 0 0 8px rgba(0,255,231,.8); 
      transition: transform 0.1s ease;
    }
    
    /* Input Controls */
    .input-group {
      margin: 1rem 0;
    }
    
    .input-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #00FFE7;
    }
    
    .input-group textarea, .input-group input, .input-group select {
      width: 100%;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e4e4e7;
      font-size: 0.875rem;
      transition: border-color 0.2s ease;
    }
    
    .input-group textarea:focus, .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #00FFE7;
      box-shadow: 0 0 0 3px rgba(0, 255, 231, 0.1);
    }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-size: 0.875rem;
    }
    
    .btn-primary {
      background: #00FFE7;
      color: #000;
    }
    
    .btn-primary:hover {
      background: rgba(0, 255, 231, 0.9);
      box-shadow: 0 0 20px rgba(0, 255, 231, 0.3);
    }
    
    .btn-secondary {
      background: transparent;
      color: #e4e4e7;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #00FFE7;
    }
    
    /* Section Management */
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .sidebar {
        order: 2;
        position: static;
      }
      .main-content {
        order: 1;
      }
    }
    
    @media (max-width: 768px) {
      .nav-tabs {
        flex-wrap: wrap;
        gap: 0.25rem;
      }
      .nav-tab {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
      }
      .controls-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      .knob {
        width: 60px;
        height: 60px;
      }
      .knob::after {
        top: 8px;
        width: 3px;
        height: 16px;
      }
    }
    
    /* Utility Classes */
    .text-neon { color: #00FFE7 !important; }
    .text-purple { color: #8b5cf6 !important; }
    .text-zinc { color: #a1a1aa !important; }
    .bg-neon { background-color: #00FFE7 !important; }
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .text-center { text-align: center; }
    .font-bold { font-weight: 700; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mb-4 { margin-bottom: 1rem; }
    .p-4 { padding: 1rem; }
    .rounded { border-radius: 0.5rem; }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- NAVIGATION -->
    <nav class="nav-bar">
      <div class="nav-content">
        <div class="flex items-center space-x-3">
          <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #00FFE7, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 12px; font-weight: bold; color: black;">S3</span>
          </div>
          <span class="text-xl font-bold text-neon">SON1KVERS3</span>
        </div>
        
        <div class="nav-tabs">
          <button class="nav-tab active" data-section="home">Historia</button>
          <button class="nav-tab" data-section="ghost-studio">Ghost Studio</button>
          <button class="nav-tab" data-section="generacion">Generación</button>
          <button class="nav-tab" data-section="archivo">Archivo</button>
          <button class="nav-tab" data-section="santuario">Santuario</button>
          <button class="nav-tab" data-section="planes">Planes</button>
        </div>
        
        <div class="text-sm">
          <div class="text-zinc">Plan: <span class="text-neon" id="userPlan">Free</span></div>
          <div class="text-zinc">Pistas: <span id="userTracks">0</span>/<span class="text-neon" id="userLimit">3</span></div>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT GRID -->
    <div class="main-grid">
      <!-- LEFT SIDEBAR -->
      <div class="sidebar">
        <div class="space-y-4">
          <h3 class="text-neon font-bold text-lg">LA RESISTENCIA</h3>
          
          <!-- User Info -->
          <div class="space-y-2">
            <div class="text-sm">
              <div class="text-zinc">Estado: <span class="text-neon">Activo</span></div>
              <div class="text-zinc">Sesión: <span class="text-neon">Conectado</span></div>
            </div>
          </div>
          
          <!-- Audio Visualizer -->
          <div class="p-4 bg-black/30 rounded">
            <h4 class="text-neon text-sm font-bold mb-2">Visualizador</h4>
            <canvas id="visualizerCanvas" width="200" height="60" style="width: 100%; height: 60px; background: rgba(0,0,0,0.5); border-radius: 4px;"></canvas>
          </div>
          
          <!-- System Status -->
          <div class="p-4 bg-black/30 rounded">
            <h4 class="text-neon text-sm font-bold mb-2">Sistema</h4>
            <div class="space-y-1 text-xs">
              <div class="flex justify-between">
                <span>Suno API:</span>
                <span class="text-green-400">●</span>
              </div>
              <div class="flex justify-between">
                <span>Ollama AI:</span>
                <span class="text-green-400">●</span>
              </div>
              <div class="flex justify-between">
                <span>Storage:</span>
                <span class="text-green-400">●</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER CONTENT -->
      <div class="main-content">
        <!-- HOME SECTION -->
        <section id="home" class="section active">
          <div class="text-center space-y-4">
            <div class="space-y-2">
              <p class="text-sm text-zinc uppercase tracking-wider">LA RESISTENCIA</p>
              <h1 class="text-3xl md:text-4xl font-bold">
                Lo imperfecto también<br>
                <span class="text-neon">es sagrado</span>
              </h1>
              <h2 class="text-lg text-zinc">
                Componer con alma en un mundo de máquinas.
              </h2>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 justify-center mt-6">
              <button id="entrarEstudio" class="btn btn-primary">Entrar al Estudio</button>
              <button class="btn btn-secondary">Conocer el Universo</button>
            </div>
            
            <p class="text-sm text-zinc max-w-lg mx-auto mt-4">
              Genera música, clona voces cantadas, mezcla con calidad de estudio y guarda tu proceso en un archivo vivo. Bienvenido al Estudio Fantasma.
            </p>
          </div>
          
          <!-- Expression Controls -->
          <div class="mt-8">
            <h3 class="text-lg font-bold text-center mb-4">Controles de Expresividad</h3>
            <div class="controls-grid">
              <div class="control-item">
                <div class="knob" data-knob="expresividad" data-value="75"></div>
                <p class="text-sm text-zinc">Expresividad</p>
                <p class="text-xs text-neon" id="expresividadDisplay">75%</p>
              </div>
              <div class="control-item">
                <div class="knob" data-knob="creatividad" data-value="60"></div>
                <p class="text-sm text-zinc">Creatividad</p>
                <p class="text-xs text-neon" id="creatividadDisplay">60%</p>
              </div>
              <div class="control-item">
                <div class="knob" data-knob="precision" data-value="80"></div>
                <p class="text-sm text-zinc">Precisión</p>
                <p class="text-xs text-neon" id="precisionDisplay">80%</p>
              </div>
            </div>
          </div>
        </section>

        <!-- GENERATION SECTION -->
        <section id="generacion" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Generación Musical</h2>
            
            <div class="input-group">
              <label for="letraCancion">Letra de la canción</label>
              <textarea id="letraCancion" rows="4" placeholder="Escribe la letra de tu canción aquí..."></textarea>
            </div>
            
            <div class="input-group">
              <label for="promptEstilo">Prompt de estilo</label>
              <input type="text" id="promptEstilo" placeholder="Ej: rock alternativo, guitarra eléctrica, batería potente">
            </div>
            
            <div class="input-group">
              <label for="presetGeneracion">Preset de generación</label>
              <select id="presetGeneracion">
                <option value="profesional">Profesional</option>
                <option value="experimental">Experimental</option>
                <option value="clasico">Clásico</option>
                <option value="moderno">Moderno</option>
              </select>
            </div>
            
            <div class="text-center">
              <button id="generarMusica" class="btn btn-primary">🎵 Generar Música</button>
            </div>
            
            <!-- Generation Controls -->
            <div class="controls-grid mt-6">
              <div class="control-item">
                <div class="knob" data-knob="afinacion" data-value="60"></div>
                <p class="text-sm text-zinc">Afinación</p>
                <p class="text-xs text-neon" id="afinacionDisplay">60%</p>
              </div>
              <div class="control-item">
                <div class="knob" data-knob="expresividad-gen" data-value="75"></div>
                <p class="text-sm text-zinc">Expresividad</p>
                <p class="text-xs text-neon" id="expresividadGenDisplay">75%</p>
              </div>
            </div>
          </div>
        </section>

        <!-- GHOST STUDIO SECTION -->
        <section id="ghost-studio" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Ghost Studio</h2>
            <p class="text-center text-zinc">Transformación avanzada de audio con IA</p>
            
            <div class="input-group">
              <label for="audioFile">Subir archivo de audio</label>
              <input type="file" id="audioFile" accept="audio/*">
            </div>
            
            <div class="input-group">
              <label for="transformationType">Tipo de transformación</label>
              <select id="transformationType">
                <option value="vocal-clone">Clonación vocal</option>
                <option value="style-transfer">Transferencia de estilo</option>
                <option value="mastering">Masterización</option>
                <option value="noise-reduction">Reducción de ruido</option>
              </select>
            </div>
            
            <div class="text-center">
              <button id="transformAudio" class="btn btn-primary">🎛️ Transformar Audio</button>
            </div>
          </div>
        </section>

        <!-- ARCHIVE SECTION -->
        <section id="archivo" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">El Archivo</h2>
            <p class="text-center text-zinc">Tu música generada</p>
            
            <div id="tracksList" class="space-y-4">
              <div class="p-4 bg-black/30 rounded">
                <p class="text-zinc">No hay pistas guardadas aún.</p>
                <p class="text-sm text-zinc">Genera tu primera canción para comenzar tu archivo.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- SANCTUARY SECTION -->
        <section id="santuario" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Santuario</h2>
            <p class="text-center text-zinc">Configuración y ajustes avanzados</p>
            
            <div class="space-y-4">
              <div class="input-group">
                <label for="aiModel">Modelo de IA</label>
                <select id="aiModel">
                  <option value="suno-v3">Suno v3</option>
                  <option value="suno-v2">Suno v2</option>
                </select>
              </div>
              
              <div class="input-group">
                <label for="outputQuality">Calidad de salida</label>
                <select id="outputQuality">
                  <option value="high">Alta (320kbps)</option>
                  <option value="medium">Media (192kbps)</option>
                  <option value="low">Baja (128kbps)</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- PLANS SECTION -->
        <section id="planes" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Planes de Suscripción</h2>
            
            <div class="grid md:grid-cols-3 gap-4">
              <div class="p-4 border border-white/20 rounded">
                <h3 class="text-lg font-bold text-neon">Free</h3>
                <p class="text-2xl font-bold">$0<span class="text-sm">/mes</span></p>
                <ul class="text-sm text-zinc space-y-1 mt-4">
                  <li>✓ 3 pistas por mes</li>
                  <li>✓ Calidad estándar</li>
                  <li>✓ Funciones básicas</li>
                </ul>
              </div>
              
              <div class="p-4 border border-neon rounded bg-neon/10">
                <h3 class="text-lg font-bold text-neon">Pro</h3>
                <p class="text-2xl font-bold">$10<span class="text-sm">/mes</span></p>
                <ul class="text-sm text-zinc space-y-1 mt-4">
                  <li>✓ 50 pistas por mes</li>
                  <li>✓ Calidad premium</li>
                  <li>✓ Ghost Studio incluido</li>
                  <li>✓ Sin marca de agua</li>
                </ul>
              </div>
              
              <div class="p-4 border border-purple/50 rounded">
                <h3 class="text-lg font-bold text-purple">Enterprise</h3>
                <p class="text-2xl font-bold">$50<span class="text-sm">/mes</span></p>
                <ul class="text-sm text-zinc space-y-1 mt-4">
                  <li>✓ 500 pistas por mes</li>
                  <li>✓ Calidad ultra</li>
                  <li>✓ API access</li>
                  <li>✓ Soporte prioritario</li>
                </ul>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="sidebar">
        <div class="space-y-4">
          <h3 class="text-neon font-bold text-lg">Asistente IA</h3>
          
          <!-- AI Chat -->
          <div class="p-4 bg-black/30 rounded">
            <div id="chatMessages" class="space-y-2 mb-4 h-48 overflow-y-auto">
              <div class="text-sm text-zinc">
                <span class="text-neon">IA:</span> ¡Hola! Soy tu asistente musical. ¿En qué puedo ayudarte hoy?
              </div>
            </div>
            <div class="flex gap-2">
              <input type="text" id="chatInput" placeholder="Pregunta algo..." class="flex-1 text-sm p-2 bg-black/50 border border-white/20 rounded">
              <button id="sendChat" class="btn btn-primary text-sm">Enviar</button>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="space-y-2">
            <h4 class="text-neon text-sm font-bold">Acciones Rápidas</h4>
            <button class="btn btn-secondary w-full text-sm">💡 Generar Letra</button>
            <button class="btn btn-secondary w-full text-sm">🎼 Sugerir Acordes</button>
            <button class="btn btn-secondary w-full text-sm">🎨 Inspiración Musical</button>
          </div>
          
          <!-- Recent Activity -->
          <div class="p-4 bg-black/30 rounded">
            <h4 class="text-neon text-sm font-bold mb-2">Actividad Reciente</h4>
            <div class="space-y-1 text-xs text-zinc">
              <div>• Sistema iniciado</div>
              <div>• Conectado a Suno API</div>
              <div>• Listo para generar</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MUSIC PLAYER (Fixed Position) -->
  <div id="musicPlayer" class="hidden fixed bottom-4 left-4 right-4 bg-black/90 backdrop-blur-xl border border-white/20 rounded-lg p-4 z-50">
    <div class="flex items-center gap-4">
      <button id="playPauseBtn" class="btn btn-primary">▶</button>
      <div class="flex-1">
        <div class="text-sm font-bold" id="trackTitle">Título de la pista</div>
        <div class="text-xs text-zinc" id="trackArtist">Generado por Son1kVers3</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="downloadBtn" class="btn btn-secondary text-sm">⬇ Descargar</button>
        <button id="closePlayer" class="text-zinc hover:text-neon cursor-pointer">✕</button>
      </div>
    </div>
    <audio id="audioPlayer" class="w-full mt-2" controls></audio>
  </div>

  <!-- TOAST NOTIFICATIONS -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Global variables
    let currentSection = 'home';
    let userSession = {
      plan: 'Free',
      tracksUsed: 0,
      tracksLimit: 3
    };
    
    const API_BASE_URL = window.location.origin;
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      setupNavigation();
      setupKnobs();
      setupAudioVisualizer();
      setupEventListeners();
      updateUserStats();
    });
    
    // Navigation
    function setupNavigation() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const targetSection = e.target.dataset.section;
          showSection(targetSection);
          
          // Update active tab
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
        });
      });
    }
    
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show target section
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.add('active');
        currentSection = sectionName;
      }
    }
    
    // Knob controls
    function setupKnobs() {
      document.querySelectorAll('.knob').forEach(knob => {
        let isDragging = false;
        let startAngle = 0;
        let currentValue = parseInt(knob.dataset.value) || 50;
        
        updateKnobRotation(knob, currentValue);
        
        knob.addEventListener('mousedown', startDrag);
        knob.addEventListener('touchstart', startDrag);
        
        function startDrag(e) {
          isDragging = true;
          const rect = knob.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
          const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
          
          startAngle = Math.atan2(clientY - centerY, clientX - centerX);
          
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
          document.addEventListener('touchmove', drag);
          document.addEventListener('touchend', stopDrag);
          
          e.preventDefault();
        }
        
        function drag(e) {
          if (!isDragging) return;
          
          const rect = knob.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
          const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
          
          const currentAngle = Math.atan2(clientY - centerY, clientX - centerX);
          const deltaAngle = currentAngle - startAngle;
          
          currentValue += (deltaAngle * 180 / Math.PI) / 3;
          currentValue = Math.max(0, Math.min(100, currentValue));
          
          updateKnobRotation(knob, currentValue);
          updateKnobDisplay(knob.dataset.knob, currentValue);
          
          startAngle = currentAngle;
          e.preventDefault();
        }
        
        function stopDrag() {
          isDragging = false;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', drag);
          document.removeEventListener('touchend', stopDrag);
        }
      });
    }
    
    function updateKnobRotation(knob, value) {
      const rotation = (value / 100) * 270 - 135; // -135 to +135 degrees
      knob.style.setProperty('--rotation', rotation + 'deg');
    }
    
    function updateKnobDisplay(knobType, value) {
      const displays = {
        'expresividad': 'expresividadDisplay',
        'creatividad': 'creatividadDisplay', 
        'precision': 'precisionDisplay',
        'afinacion': 'afinacionDisplay',
        'expresividad-gen': 'expresividadGenDisplay'
      };
      
      const displayId = displays[knobType];
      if (displayId) {
        const display = document.getElementById(displayId);
        if (display) {
          display.textContent = Math.round(value) + '%';
        }
      }
    }
    
    // Audio visualizer
    function setupAudioVisualizer() {
      const canvas = document.getElementById('visualizerCanvas');
      const ctx = canvas.getContext('2d');
      
      // Simple animated visualizer
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw animated bars
        const barCount = 20;
        const barWidth = canvas.width / barCount;
        
        for (let i = 0; i < barCount; i++) {
          const height = Math.random() * canvas.height * 0.7 + 10;
          const x = i * barWidth;
          const y = canvas.height - height;
          
          const gradient = ctx.createLinearGradient(0, y, 0, canvas.height);
          gradient.addColorStop(0, '#00FFE7');
          gradient.addColorStop(1, '#8b5cf6');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, y, barWidth - 2, height);
        }
        
        requestAnimationFrame(animate);
      }
      
      animate();
    }
    
    // Event listeners
    function setupEventListeners() {
      // Generation button
      document.getElementById('generarMusica')?.addEventListener('click', generarMusica);
      
      // Studio entry buttons
      document.getElementById('entrarEstudio')?.addEventListener('click', () => showSection('generacion'));
      
      // Chat functionality
      document.getElementById('sendChat')?.addEventListener('click', sendChatMessage);
      document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
    }
    
    // Music generation
    async function generarMusica() {
      if (!checkUserLimits()) return;
      
      const letra = document.getElementById('letraCancion').value;
      const estilo = document.getElementById('promptEstilo').value;
      const preset = document.getElementById('presetGeneracion').value;
      
      if (!letra && !estilo) {
        showToast('Por favor ingresa una letra o prompt de estilo', 'warning');
        return;
      }
      
      const btn = document.getElementById('generarMusica');
      btn.disabled = true;
      btn.textContent = 'Generando música...';
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: estilo || 'canción con letra personalizada',
            lyrics: letra || '',
            style: preset || 'profesional',
            user_plan: userSession.plan
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.tracks && data.tracks.length > 0) {
          const track = data.tracks[0];
          showToast('¡Música generada con éxito!', 'success');
          
          userSession.tracksUsed++;
          updateUserStats();
          
          showMusicPlayer(track);
        } else {
          showToast('Error al generar música: ' + (data.error || 'Error desconocido'), 'error');
        }
      } catch (error) {
        showToast('Error al generar música: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '🎵 Generar Música';
      }
    }
    
    // User limits check
    function checkUserLimits() {
      if (userSession.tracksUsed >= userSession.tracksLimit) {
        showToast('Has alcanzado el límite de pistas para tu plan. Actualiza para continuar.', 'warning');
        return false;
      }
      return true;
    }
    
    // Update user stats
    function updateUserStats() {
      document.getElementById('userPlan').textContent = userSession.plan;
      document.getElementById('userTracks').textContent = userSession.tracksUsed;
      document.getElementById('userLimit').textContent = userSession.tracksLimit;
    }
    
    // Music player
    function showMusicPlayer(track) {
      const player = document.getElementById('musicPlayer');
      const audio = document.getElementById('audioPlayer');
      const title = document.getElementById('trackTitle');
      
      if (track.audio_url) {
        audio.src = track.audio_url;
        title.textContent = track.title || 'Nueva generación';
        player.classList.remove('hidden');
      }
    }
    
    // Chat functionality
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const chatMessages = document.getElementById('chatMessages');
      
      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'text-sm';
      userMsg.innerHTML = `<span class="text-neon">Tú:</span> ${message}`;
      chatMessages.appendChild(userMsg);
      
      // Simulate AI response
      setTimeout(() => {
        const aiMsg = document.createElement('div');
        aiMsg.className = 'text-sm text-zinc';
        aiMsg.innerHTML = `<span class="text-neon">IA:</span> Interesante pregunta sobre ${message}. ¿Te gustaría que genere algo específico?`;
        chatMessages.appendChild(aiMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 1000);
      
      input.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Toast notifications
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      toast.className = `${colors[type]} text-white px-4 py-3 rounded shadow-lg`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }
    
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => console.log('SW registered'))
        .catch(error => console.log('SW registration failed'));
    }
  </script>
</body>
</html>