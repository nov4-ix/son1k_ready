<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Son1kVers3 ‚Äî La Resistencia</title>
  
  <!-- SEO / Share / PWA -->
  <meta name="description" content="Son1kVers3: Genera m√∫sica, Ghost Studio y Archivo central. Lo imperfecto tambi√©n es sagrado.">
  <meta property="og:title" content="Son1kVers3 ‚Äî Resistencia sonora">
  <meta property="og:description" content="Texto‚ÜíM√∫sica, Ghost Studio, Archivo.">
  <meta name="theme-color" content="#0b0b0d">
  
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { 
            neon: '#00FFE7', 
            coal: '#0B0B0F', 
            haze: '#0f111a',
            'neon-purple': '#8b5cf6',
            'neon-blue': '#06b6d4' 
          },
          boxShadow: { glow: '0 0 40px rgba(0,255,231,.25)' }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    html { background: #0f111a !important; }
    body { background: #0f111a !important; color: #e4e4e7 !important; font-family: Inter, ui-sans-serif, system-ui !important; }
    
    .glitch { position: relative; }
    .glitch::before, .glitch::after { content: attr(data-text); position: absolute; inset: 0; pointer-events: none; }
    .glitch::before { left: 2px; text-shadow: -2px 0 #f0f; clip-path: inset(10% 0 30% 0); }
    .glitch::after { left: -2px; text-shadow: -2px 0 #0ff; clip-path: inset(60% 0 5% 0); }
    
    .knob { 
      width: 80px; height: 80px; border-radius: 50%; position: relative; 
      background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      cursor: pointer; transition: all 0.2s ease;
      border: 3px solid #333;
      margin: 0 auto;
      user-select: none;
    }
    .knob:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,231,.3); }
    .knob:focus-visible { 
      outline: 2px solid #00FFE7; 
      outline-offset: 2px; 
    }
    .knob::after { 
      content: ''; position: absolute; left: 50%; top: 10px; 
      width: 4px; height: 20px; background: #00FFE7; border-radius: 2px; 
      transform: translateX(-50%) rotate(var(--rotation, 0deg)); 
      box-shadow: 0 0 8px rgba(0,255,231,.8); 
      transition: transform 0.1s ease;
    }
    
    .knob-small { 
      width: 60px; height: 60px; 
    }
    .knob-small::after { 
      top: 8px; 
      width: 3px; height: 16px; 
    }
    
    .slider-container {
      position: relative;
      margin: 20px 0;
    }
    
    .custom-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: linear-gradient(90deg, #333 0%, #00FFE7 var(--value, 50%), #333 var(--value, 50%));
      outline: none;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    
    .custom-slider:hover {
      opacity: 1;
    }
    
    .custom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00FFE7;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,255,231,.5);
    }
    
    .custom-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00FFE7;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(0,255,231,.5);
    }
    
    .text-neon { color: #00FFE7 !important; }
    .bg-neon { background-color: #00FFE7 !important; }
    .border-neon { border-color: #00FFE7 !important; }
    .shadow-glow { box-shadow: 0 0 40px rgba(0,255,231,.25) !important; }
    .bg-haze { background-color: #0f111a !important; }
    
    .tab-active { 
      background: linear-gradient(45deg, #00FFE7, #8b5cf6);
      color: #000;
    }
    
    .section-hidden { display: none; }
    
    @keyframes pulse-neon {
      0%, 100% { box-shadow: 0 0 5px rgba(0,255,231,.5); }
      50% { box-shadow: 0 0 20px rgba(0,255,231,.8); }
    }
    
    .pulse-neon { animation: pulse-neon 2s infinite; }
    
    /* Botones con focus visible */
    .btn:focus-visible {
      outline: 2px solid #00FFE7;
      outline-offset: 2px;
    }
    
    /* Status indicators */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-online { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
    .status-offline { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
    .status-pending { background-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }

    /* Optimizaci√≥n m√≥vil - reducir blur en pantallas peque√±as */
    @media (max-width: 768px) {
      .blur-3xl { filter: blur(16px); }
      .backdrop-blur-xl { backdrop-filter: blur(8px); }
    }
    
    /* Respeto a preferencias de movimiento reducido */
    @media (prefers-reduced-motion: reduce) {
      .pulse-neon { animation: none; }
      .transition { transition: none; }
      .knob::after { transition: none; }
    }
  </style>
</head>

<body class="antialiased overflow-x-hidden bg-haze">
  <!-- Audio player global para reproducci√≥n (sr-only para producci√≥n, quita esta clase para debug) -->
  <audio id="player" class="sr-only" aria-hidden="true"></audio>
  
  <!-- Contenedor de toasts accesible -->
  <div id="toast-area" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- NAVEGACI√ìN -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-zinc-950/80 backdrop-blur-xl border-b border-white/10" role="navigation">
    <div class="mx-auto max-w-7xl px-4 flex items-center justify-between h-16">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-neon to-neon-purple flex items-center justify-center">
          <span class="text-xs font-bold text-black">S3</span>
        </div>
        <span class="text-xl font-bold text-neon">SON1KVERS3</span>
      </div>
      
      <div class="flex space-x-6" role="tablist">
        <button class="nav-tab tab-active px-4 py-2 rounded-lg transition btn" 
                data-section="home" 
                role="tab" 
                aria-selected="true">Historia</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="ghost-studio" 
                role="tab" 
                aria-selected="false">Ghost Studio</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="generacion" 
                role="tab" 
                aria-selected="false">Generaci√≥n</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="extension" 
                role="tab" 
                aria-selected="false">Extensi√≥n</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="archivo" 
                role="tab" 
                aria-selected="false">Archivo</button>
      </div>
      
      <!-- Botones de autenticaci√≥n -->
      <div id="authButtons" class="flex space-x-3">
        <button onclick="showLoginModal()" class="border border-white/20 px-4 py-2 rounded-lg hover:bg-white/5 transition btn">
          Login
        </button>
        <button onclick="showRegisterModal()" class="bg-neon text-black px-4 py-2 rounded-lg font-semibold hover:bg-neon/90 transition btn">
          Registro
        </button>
      </div>
      
      <!-- Informaci√≥n del usuario autenticado -->
      <div id="userInfo" style="display: none;"></div>
      
      <!-- Bot√≥n "Entrar al Estudio" (redirigir√° o pedir√° auth) -->
      <button id="entrarEstudio" class="bg-neon text-black px-6 py-2 rounded-lg font-semibold hover:bg-neon/90 transition btn">
        Entrar al Estudio
      </button>
    </div>
  </nav>

  <!-- SECCI√ìN HOME -->
  <section id="home" class="content-section min-h-screen pt-20 pb-10" aria-hidden="false">
    <div class="mx-auto max-w-7xl px-4 grid lg:grid-cols-2 gap-12 items-center min-h-[80vh]">
      <div class="space-y-8">
        <div class="space-y-2">
          <p class="text-sm font-medium text-zinc-400 tracking-widest uppercase">LA RESISTENCIA</p>
          <h1 class="text-4xl md:text-6xl font-bold leading-tight">
            Lo imperfecto tambi√©n<br>
            <span class="text-neon">es sagrado</span>
          </h1>
          <h2 class="text-2xl md:text-3xl text-zinc-300 mt-4">
            Componer con alma<br>
            en un mundo de<br>
            <span class="text-neon-purple">m√°quinas.</span>
          </h2>
        </div>
        
        <div class="flex space-x-4">
          <button id="entrarEstudioMain" class="bg-neon text-black px-8 py-3 rounded-lg font-semibold hover:bg-neon/90 transition shadow-glow btn">
            Entrar al Estudio
          </button>
          <button id="conocerUniverso" class="border border-white/20 px-8 py-3 rounded-lg hover:bg-white/5 transition btn">
            Conocer el Universo
          </button>
        </div>
        
        <p class="text-zinc-400 max-w-lg">
          Genera m√∫sica, clona voces cantadas, mezcla con calidad de estudio y guarda tu proceso en un archivo vivo. Bienvenido al Estudio Fantasma.
        </p>

        <!-- Sistema de Status -->
        <div class="bg-zinc-900/30 rounded-xl border border-white/10 p-6">
          <h3 class="text-lg font-semibold mb-4">Estado del Sistema</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex items-center">
              <span id="api-status" class="status-indicator status-online"></span>
              <span>API Backend</span>
            </div>
            <div class="flex items-center">
              <span id="celery-status" class="status-indicator status-offline"></span>
              <span>Celery Worker</span>
            </div>
            <div class="flex items-center">
              <span id="redis-status" class="status-indicator status-offline"></span>
              <span>Redis</span>
            </div>
            <div class="flex items-center">
              <span id="extension-status" class="status-indicator status-offline"></span>
              <span>Chrome Extension</span>
            </div>
          </div>
          <button class="mt-4 text-neon text-sm hover:underline btn" onclick="refreshSystemStatus()">üîÑ Refresh Status</button>
        </div>
      </div>
      
      <div class="relative">
        <div class="absolute -inset-10 -z-10 blur-3xl opacity-30" style="background: conic-gradient(from 45deg, rgba(0,255,231,.2), transparent, rgba(99,102,241,.2))"></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8 shadow-2xl">
          <div class="text-center mb-6">
            <h3 class="text-xl font-semibold mb-2">Controles de Expresividad</h3>
            <p class="text-sm text-zinc-400">Ajusta los par√°metros para crear tu sonido √∫nico</p>
          </div>
          
          <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="text-center">
              <div class="knob" 
                   data-knob="expresividad" 
                   data-value="75"
                   role="slider"
                   tabindex="0"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   aria-valuenow="75"
                   aria-label="Expresividad"></div>
              <p class="text-sm mt-2 text-zinc-400">Expresividad</p>
              <p class="text-xs text-neon font-mono" id="expresividadDisplay">75%</p>
            </div>
            <div class="text-center">
              <div class="knob" 
                   data-knob="creatividad" 
                   data-value="60"
                   role="slider"
                   tabindex="0"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   aria-valuenow="60"
                   aria-label="Creatividad"></div>
              <p class="text-sm mt-2 text-zinc-400">Creatividad</p>
              <p class="text-xs text-neon font-mono" id="creatividadDisplay">60%</p>
            </div>
            <div class="text-center">
              <div class="knob" 
                   data-knob="precision" 
                   data-value="85"
                   role="slider"
                   tabindex="0"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   aria-valuenow="85"
                   aria-label="Precisi√≥n"></div>
              <p class="text-sm mt-2 text-zinc-400">Precisi√≥n</p>
              <p class="text-xs text-neon font-mono" id="precisionDisplay">85%</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <button id="testRapido" class="rounded-lg border border-neon/30 text-neon px-4 py-3 hover:bg-neon/10 transition font-medium btn">
              Test R√°pido
            </button>
            <button id="generarPreview" class="rounded-lg bg-neon/10 border border-neon text-neon px-4 py-3 hover:bg-neon/20 transition font-medium btn">
              Generar Preview
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN GENERACI√ìN -->
  <section id="generacion" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Generaci√≥n Musical</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Beats, letras, voces cantadas clonadas y mezcla con calidad de estudio. Todo en un flujo.</p>
        <div class="flex justify-center space-x-4 mt-6">
          <button class="bg-neon/10 text-neon px-4 py-2 rounded-lg border border-neon btn">API</button>
          <button class="bg-white/5 text-white px-4 py-2 rounded-lg border border-white/20 btn">Docs</button>
        </div>
      </div>
      
      <!-- Generaci√≥n Musical Simple -->
      <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
        <h3 class="text-2xl font-semibold mb-6 text-center">Generaci√≥n Musical Simple</h3>
        <div class="grid lg:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-zinc-300 mb-2">Letra de la canci√≥n</label>
              <textarea 
                class="w-full h-32 bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white resize-none"
                placeholder="Escribe aqu√≠ la letra de tu canci√≥n..."
                id="letraCancion"
              ></textarea>
              <div class="flex space-x-2 mt-2">
                <button id="generarLetraIA" class="text-xs bg-neon-purple/20 text-neon-purple px-3 py-2 rounded-lg hover:bg-neon-purple/30 transition btn">
                  ü§ñ Generar Letra con IA
                </button>
                <button id="mejorarLetra" class="text-xs bg-neon-blue/20 text-neon-blue px-3 py-2 rounded-lg hover:bg-neon-blue/30 transition btn">
                  ‚ú® Mejorar Letra
                </button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-zinc-300 mb-2">Prompt de estilo musical</label>
              <input 
                type="text" 
                class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white"
                placeholder="Ej: una balada emotiva con piano y cuerdas, estilo neo-soul, tempo 70 BPM"
                id="promptEstilo"
              >
              <div class="flex space-x-2 mt-2">
                <button id="promptInteligente" class="text-xs bg-neon/20 text-neon px-3 py-2 rounded-lg hover:bg-neon/30 transition btn">
                  üéØ Prompt Inteligente
                </button>
                <button id="analizarTexto" class="text-xs bg-yellow-500/20 text-yellow-500 px-3 py-2 rounded-lg hover:bg-yellow-500/30 transition btn">
                  üìä Analizar Texto
                </button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-zinc-300 mb-2">Preset de generaci√≥n</label>
              <select class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white" id="presetGeneracion">
                <option>Profesional</option>
                <option>Experimental</option>
                <option>Vintage</option>
                <option>Moderno</option>
                <option>Cinematogr√°fico</option>
              </select>
            </div>
            
            <!-- Toggle instrumental a√±adido -->
            <label class="inline-flex items-center gap-2">
              <input id="modoInstrumental" type="checkbox">
              <span class="text-sm text-zinc-300">Generar instrumental (sin voz)</span>
            </label>
          </div>
          
          <div class="space-y-6">
            <div>
              <h4 class="text-lg font-medium mb-4">Controles de Expresividad</h4>
              <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                  <div class="knob knob-small" 
                       data-knob="afinacion" 
                       data-value="60"
                       role="slider"
                       tabindex="0"
                       aria-valuemin="0"
                       aria-valuemax="100"
                       aria-valuenow="60"
                       aria-label="Afinaci√≥n"></div>
                  <p class="text-xs mt-1 text-zinc-400">Afinaci√≥n</p>
                  <p class="text-xs text-neon" id="afinacionDisplay">60%</p>
                </div>
                <div class="text-center">
                  <div class="knob knob-small" 
                       data-knob="expresividad-gen" 
                       data-value="75"
                       role="slider"
                       tabindex="0"
                       aria-valuemin="0"
                       aria-valuemax="100"
                       aria-valuenow="75"
                       aria-label="Expresividad"></div>
                  <p class="text-xs mt-1 text-zinc-400">Expresividad</p>
                  <p class="text-xs text-neon" id="expresividadGenDisplay">75%</p>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="text-lg font-medium mb-4">Postprocesamiento</h4>
              <div class="space-y-3">
                <div>
                  <label class="text-xs text-zinc-400">EQ (SSL-style)</label>
                  <input type="range" class="custom-slider w-full" value="50" min="0" max="100" id="eq">
                </div>
                <div class="grid grid-cols-4 gap-2">
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="low" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="Low"></div>
                    <p class="text-xs text-zinc-400">Low</p>
                  </div>
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="mid" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="Mid"></div>
                    <p class="text-xs text-zinc-400">Mid</p>
                  </div>
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="high" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="High"></div>
                    <p class="text-xs text-zinc-400">High</p>
                  </div>
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="air" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="Air"></div>
                    <p class="text-xs text-zinc-400">Air</p>
                  </div>
                </div>
                <div>
                  <label class="text-xs text-zinc-400">Saturaci√≥n (Rupert-style)</label>
                  <input type="range" class="custom-slider w-full" value="30" min="0" max="100" id="saturacion">
                </div>
              </div>
            </div>
            
            <button id="generarMusica" class="w-full bg-neon text-black rounded-lg py-4 font-semibold text-lg hover:bg-neon/90 transition shadow-glow btn" disabled>
              Generar M√∫sica
            </button>
            <p class="text-xs text-zinc-400 text-center mt-2">* Requiere cuenta registrada</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN GHOST STUDIO -->
  <section id="ghost-studio" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Ghost Studio</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Sube tu demo o escribe un prompt. El Estudio Fantasma devuelve una maqueta con mezcla y car√°cter.</p>
        <div class="inline-flex items-center space-x-2 mt-4">
          <div class="w-3 h-3 bg-neon rounded-full pulse-neon"></div>
          <span class="text-sm text-neon">online</span>
        </div>
      </div>
      
      <div class="max-w-4xl mx-auto">
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <div class="mb-8">
            <label class="block text-lg font-medium text-zinc-300 mb-4">Prompt de Generaci√≥n Musical</label>
            <textarea 
              class="w-full h-24 bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white resize-none"
              placeholder="Ej: una balada emotiva con piano y cuerdas, estilo neo-soul, tempo 70 BPM, voz masculina expresiva"
              id="promptGhostStudio"
            ></textarea>
          </div>
          
          <div class="mb-8">
            <label class="block text-lg font-medium text-zinc-300 mb-4">Preset</label>
            <select class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white" id="presetGhost">
              <option>Profesional</option>
              <option>Experimental</option>
              <option>Vintage</option>
              <option>Crudo</option>
              <option>Cinematogr√°fico</option>
            </select>
          </div>
          
          <div class="mb-8">
            <label class="block text-lg font-medium text-zinc-300 mb-4">Tags/Estilo</label>
            <input 
              type="text" 
              class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white"
              placeholder="pop, ballad, emotional, piano"
              id="tagsEstilo"
            >
          </div>
          
          <!-- Toggle instrumental a√±adido para Ghost Studio -->
          <div class="mb-8">
            <label class="inline-flex items-center gap-2">
              <input id="modoInstrumentalGhost" type="checkbox">
              <span class="text-sm text-zinc-300">Procesar instrumental</span>
            </label>
          </div>
          
          <div class="grid lg:grid-cols-2 gap-8 mb-8">
            <div>
              <h4 class="text-lg font-medium mb-4">Afinaci√≥n</h4>
              <div class="slider-container">
                <input type="range" class="custom-slider w-full" value="60" min="0" max="100" id="afinacionGhost">
                <p class="text-center text-sm text-zinc-400 mt-2">60%</p>
              </div>
            </div>
            
            <div>
              <h4 class="text-lg font-medium mb-4">Expresividad</h4>
              <div class="slider-container">
                <input type="range" class="custom-slider w-full" value="75" min="0" max="100" id="expresividadGhost">
                <p class="text-center text-sm text-zinc-400 mt-2">75%</p>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <button id="generarMusicaGhost" class="bg-neon text-black rounded-lg py-4 font-semibold text-lg hover:bg-neon/90 transition btn" disabled>
              Generar M√∫sica
            </button>
            <button id="verificarAPIs" class="border border-white/20 rounded-lg py-4 font-semibold hover:bg-white/5 transition btn">
              Verificar APIs
            </button>
          </div>
          <p class="text-xs text-zinc-400 text-center mt-2">* Requiere cuenta registrada</p>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN EXTENSI√ìN -->
  <section id="extension" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Chrome Extension</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Conecta Suno.com directamente con Son1k para enviar prompts musicales</p>
      </div>
      
      <div class="max-w-4xl mx-auto space-y-8">
        <!-- Extension Status -->
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <h3 class="text-xl font-semibold mb-6">Estado de la Extensi√≥n</h3>
          <div class="grid grid-cols-2 gap-6">
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <span>Conexi√≥n:</span>
                <span id="ext-connection-status" class="text-zinc-400">Desconectado</span>
              </div>
              <div class="flex items-center justify-between">
                <span>√öltimo ping:</span>
                <span id="ext-last-ping" class="text-zinc-400">Nunca</span>
              </div>
              <div class="flex items-center justify-between">
                <span>Backend URL:</span>
                <span class="text-neon text-sm">localhost:8000</span>
              </div>
            </div>
            <div class="space-y-4">
              <button class="w-full bg-neon/10 text-neon border border-neon rounded-lg py-3 hover:bg-neon/20 transition btn" onclick="testExtensionConnection()">
                üîç Probar Conexi√≥n
              </button>
              <button class="w-full bg-white/5 text-white border border-white/20 rounded-lg py-3 hover:bg-white/10 transition btn" onclick="openExtensionPage()">
                ‚öôÔ∏è Abrir Extensiones
              </button>
            </div>
          </div>
        </div>

        <!-- Extension Logs -->
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <h3 class="text-xl font-semibold mb-6">Logs de Extensi√≥n</h3>
          <div class="bg-zinc-900/50 border border-white/10 rounded-lg p-4 h-40 overflow-y-auto">
            <div id="extension-logs" class="space-y-1 text-sm text-zinc-400">
              <div>[INFO] Esperando conexi√≥n de extensi√≥n...</div>
            </div>
          </div>
        </div>

        <!-- Extension Guide -->
        <div class="rounded-2xl border border-neon/30 bg-gradient-to-br from-neon/5 to-neon-purple/5 p-8 backdrop-blur-xl">
          <h3 class="text-xl font-semibold mb-6">Gu√≠a de Instalaci√≥n</h3>
          <div class="space-y-4">
            <ol class="list-decimal list-inside space-y-2 text-zinc-300">
              <li>Open Chrome and go to <code>chrome://extensions/</code></li>
              <li>Enable "Developer mode" in the top right</li>
              <li>Click "Load unpacked" and select the extension folder</li>
              <li>Configure the extension popup with URL: <code>http://localhost:8000</code></li>
              <li>Visit <code>suno.com/create</code> to see the "Send to Son1k" button</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN ARCHIVO -->
  <section id="archivo" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">El Archivo</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Tu memoria creativa: canciones, presets y sesiones guardadas.</p>
        <button class="mt-4 text-neon hover:underline btn">Ver todo ‚Üí</button>
      </div>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Ejemplo de archivo -->
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 hover:bg-white/10 transition cursor-pointer">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Mi Canci√≥n Demo</h3>
            <span class="text-xs text-zinc-400">Hace 2 horas</span>
          </div>
          <p class="text-sm text-zinc-400 mb-4">Balada neo-soul con piano y cuerdas</p>
          <div class="flex space-x-2">
            <button class="text-xs bg-neon/10 text-neon px-3 py-1 rounded-full btn" data-play="true" data-src="#demo-audio">Reproducir</button>
            <button class="text-xs bg-white/5 text-white px-3 py-1 rounded-full btn">Descargar</button>
          </div>
        </div>
        
        <!-- M√°s archivos -->
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 hover:bg-white/10 transition cursor-pointer">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Preset Experimental #1</h3>
            <span class="text-xs text-zinc-400">Ayer</span>
          </div>
          <p class="text-sm text-zinc-400 mb-4">Configuraci√≥n para trap mel√≥dico</p>
          <div class="flex space-x-2">
            <button class="text-xs bg-neon/10 text-neon px-3 py-1 rounded-full btn">Cargar</button>
            <button class="text-xs bg-white/5 text-white px-3 py-1 rounded-full btn">Duplicar</button>
          </div>
        </div>
        
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 hover:bg-white/10 transition cursor-pointer">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Sesi√≥n de voz clonada</h3>
            <span class="text-xs text-zinc-400">Hace 3 d√≠as</span>
          </div>
          <p class="text-sm text-zinc-400 mb-4">Voz APLIO "Nova" - expresividad alta</p>
          <div class="flex space-x-2">
            <button class="text-xs bg-neon/10 text-neon px-3 py-1 rounded-full btn" data-play="true" data-src="#demo-audio2">Reproducir</button>
            <button class="text-xs bg-white/5 text-white px-3 py-1 rounded-full btn">Reutilizar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Variables globales
    let currentSection = 'home';
    let systemStatus = {
      api: false,
      celery: false,
      redis: false,
      extension: false
    };
    
    // API configurable para desarrollo y producci√≥n
    const API_BASE_URL = (() => {
      const hostname = window.location.hostname;
      
      // Local development
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:8000';
      }
      
      // Ngrok tunnel (para testing)
      if (hostname.includes('ngrok') || hostname.includes('ngrok-free.app')) {
        return window.location.origin;
      }
      
      // Production
      return 'https://son1kvers3.com';
    })();
    
    // Configuraci√≥n de knobs con soporte m√≥vil, teclado y ARIA
    function setupKnobs() {
      document.querySelectorAll('.knob').forEach(knob => {
        let isDragging = false;
        let startY = 0;
        let startValue = parseInt(knob.dataset.value) || 50;
        
        // Configurar ARIA
        knob.setAttribute('role', 'slider');
        knob.setAttribute('tabindex', '0');
        knob.setAttribute('aria-valuemin', '0');
        knob.setAttribute('aria-valuemax', '100');
        knob.setAttribute('aria-valuenow', startValue);
        
        // Establecer rotaci√≥n inicial
        updateKnobRotation(knob, startValue);
        
        // Funci√≥n para actualizar valor
        const setValue = (newValue) => {
          newValue = Math.min(100, Math.max(0, newValue));
          knob.dataset.value = newValue;
          knob.setAttribute('aria-valuenow', newValue);
          updateKnobRotation(knob, newValue);
          updateKnobDisplay(knob.dataset.knob, newValue);
        };
        
        // Mouse events
        knob.addEventListener('mousedown', (e) => {
          isDragging = true;
          startY = e.clientY;
          startValue = parseInt(knob.dataset.value) || 50;
          knob.style.cursor = 'grabbing';
          e.preventDefault();
        });
        
        // Touch events
        knob.addEventListener('touchstart', (e) => {
          isDragging = true;
          startY = e.touches[0].clientY;
          startValue = parseInt(knob.dataset.value) || 50;
        }, { passive: true });
        
        // Mouse move
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          const deltaY = startY - e.clientY;
          const sensitivity = 1;
          setValue(startValue + deltaY * sensitivity);
        });
        
        // Touch move
        window.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          const deltaY = startY - e.touches[0].clientY;
          const sensitivity = 1;
          setValue(startValue + deltaY * sensitivity);
        }, { passive: true });
        
        // Mouse up
        document.addEventListener('mouseup', () => {
          if (isDragging) {
            isDragging = false;
            knob.style.cursor = 'pointer';
          }
        });
        
        // Touch end
        window.addEventListener('touchend', () => {
          isDragging = false;
        }, { passive: true });
        
        // Keyboard events
        knob.addEventListener('keydown', (e) => {
          const currentValue = parseInt(knob.dataset.value) || 50;
          
          if (['ArrowUp', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
            setValue(currentValue + 2);
          }
          if (['ArrowDown', 'ArrowLeft'].includes(e.key)) {
            e.preventDefault();
            setValue(currentValue - 2);
          }
          if (e.key === 'Home') {
            e.preventDefault();
            setValue(0);
          }
          if (e.key === 'End') {
            e.preventDefault();
            setValue(100);
          }
        });
      });
    }
    
    // Funci√≥n auxiliar para actualizar rotaci√≥n del knob
    function updateKnobRotation(knob, value) {
      const deg = -135 + (value / 100) * 270;
      knob.style.setProperty('--rotation', `${deg}deg`);
    }
    
    // Configuraci√≥n de sliders
    function setupSliders() {
      document.querySelectorAll('.custom-slider').forEach(slider => {
        const updateSlider = () => {
          const value = slider.value;
          slider.style.setProperty('--value', value + '%');
          
          // Actualizar display si existe
          const nextSibling = slider.parentNode.querySelector('p');
          if (nextSibling) {
            nextSibling.textContent = value + '%';
          }
        };
        
        slider.addEventListener('input', updateSlider);
        updateSlider(); // Inicializar
      });
    }
    
    // Actualizar displays de knobs
    function updateKnobDisplay(knobType, value) {
      const displays = {
        'expresividad': 'expresividadDisplay',
        'creatividad': 'creatividadDisplay',
        'precision': 'precisionDisplay',
        'expresividad-main': 'expresividadMainDisplay',
        'expresividad-gen': 'expresividadGenDisplay',
        'afinacion': 'afinacionDisplay'
      };
      
      const displayId = displays[knobType];
      if (displayId) {
        const display = document.getElementById(displayId);
        if (display) {
          display.textContent = Math.round(value) + '%';
        }
      }
    }
    
    // Navegaci√≥n entre secciones con ARIA
    function setupNavigation() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const targetSection = e.target.dataset.section;
          showSection(targetSection);
          
          // Actualizar tabs con ARIA
          document.querySelectorAll('.nav-tab').forEach(t => {
            t.classList.remove('tab-active');
            t.setAttribute('aria-selected', 'false');
          });
          e.target.classList.add('tab-active');
          e.target.setAttribute('aria-selected', 'true');
        });
      });
    }
    
    function showSection(sectionName) {
      // Ocultar todas las secciones
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('section-hidden');
        section.setAttribute('aria-hidden', 'true');
      });
      
      // Mostrar la secci√≥n seleccionada
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.remove('section-hidden');
        targetSection.setAttribute('aria-hidden', 'false');
        currentSection = sectionName;
      }
    }
    
    // Validaci√≥n de entradas
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                  .replace(/javascript:/gi, '')
                  .substring(0, 1000); // Limitar longitud
    }
    
    function validateUrl(url) {
      try {
        const parsed = new URL(url);
        return parsed.protocol === 'http:' || parsed.protocol === 'https:';
      } catch {
        return false;
      }
    }

    // AI Functions for Smart Prompts and Lyrics
    async function generarLetraIA() {
      const prompt = sanitizeInput(document.getElementById('promptEstilo').value);
      if (!prompt) {
        showToast('Ingresa un prompt de estilo primero para generar la letra', 'warning');
        return;
      }

      const btn = document.getElementById('generarLetraIA');
      btn.disabled = true;
      btn.textContent = 'ü§ñ Generando...';

      try {
        // Simular llamada de IA para generar letra
        const response = await fetch(`${API_BASE_URL}/api/generate-lyrics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: prompt })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('letraCancion').value = data.lyrics || "Letra generada basada en tu prompt...";
          showToast('¬°Letra generada con IA!', 'success');
        } else {
          // Fallback si no hay endpoint
          document.getElementById('letraCancion').value = "Verso 1:\n" + prompt + " me inspira\nCada nota que suena\nEn mi coraz√≥n vibra\n\nCoro:\nEsta es mi canci√≥n\nNacida del alma\nCon tu inspiraci√≥n\nHall√© la calma";
          showToast('Letra generada (modo demo)', 'info');
        }
      } catch (error) {
        // Fallback si hay error
        document.getElementById('letraCancion').value = "Verso 1:\n" + prompt + " me inspira\nCada nota que suena\nEn mi coraz√≥n vibra\n\nCoro:\nEsta es mi canci√≥n\nNacida del alma\nCon tu inspiraci√≥n\nHall√© la calma";
        showToast('Letra generada (modo demo)', 'info');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ü§ñ Generar Letra con IA';
      }
    }

    async function mejorarLetra() {
      const letra = sanitizeInput(document.getElementById('letraCancion').value);
      if (!letra) {
        showToast('Escribe una letra primero para mejorarla', 'warning');
        return;
      }

      const btn = document.getElementById('mejorarLetra');
      btn.disabled = true;
      btn.textContent = '‚ú® Mejorando...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/improve-lyrics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lyrics: letra })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('letraCancion').value = data.improved_lyrics || letra;
          showToast('¬°Letra mejorada!', 'success');
        } else {
          showToast('Letra procesada (modo demo)', 'info');
        }
      } catch (error) {
        showToast('Error al mejorar letra', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ú® Mejorar Letra';
      }
    }

    async function promptInteligente() {
      const letra = sanitizeInput(document.getElementById('letraCancion').value);
      
      const btn = document.getElementById('promptInteligente');
      btn.disabled = true;
      btn.textContent = 'üéØ Analizando...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/smart-prompt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lyrics: letra })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('promptEstilo').value = data.smart_prompt || '';
          showToast('¬°Prompt inteligente generado!', 'success');
        } else {
          // Fallback inteligente basado en an√°lisis b√°sico
          let prompt = "Una canci√≥n ";
          if (letra.toLowerCase().includes('amor')) prompt += "rom√°ntica ";
          if (letra.toLowerCase().includes('triste')) prompt += "melanc√≥lica ";
          if (letra.toLowerCase().includes('alegr')) prompt += "alegre ";
          if (letra.toLowerCase().includes('rock')) prompt += "con estilo rock ";
          prompt += "con expresi√≥n emocional, tempo medio";
          
          document.getElementById('promptEstilo').value = prompt;
          showToast('Prompt inteligente generado (an√°lisis b√°sico)', 'info');
        }
      } catch (error) {
        // Fallback b√°sico
        document.getElementById('promptEstilo').value = "Una balada emotiva con instrumentaci√≥n rica, tempo medio, expresi√≥n vocal intensa";
        showToast('Prompt generado (modo demo)', 'info');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üéØ Prompt Inteligente';
      }
    }

    async function analizarTexto() {
      const letra = sanitizeInput(document.getElementById('letraCancion').value);
      if (!letra) {
        showToast('Escribe una letra primero para analizarla', 'warning');
        return;
      }

      const btn = document.getElementById('analizarTexto');
      btn.disabled = true;
      btn.textContent = 'üìä Analizando...';

      // An√°lisis b√°sico del texto
      const words = letra.toLowerCase().split(/\s+/);
      const sentiment = {
        positive: ['amor', 'feliz', 'alegr', 'bien', 'bueno', 'genial', 'perfecto'],
        negative: ['triste', 'dolor', 'mal', 'terrible', 'horrible', 'llorar'],
        emotional: ['coraz√≥n', 'alma', 'sentir', 'emoci', 'profund']
      };

      let analysis = "An√°lisis de la letra:\n";
      analysis += `‚Ä¢ Palabras: ${words.length}\n`;
      
      const positiveCount = sentiment.positive.filter(w => letra.toLowerCase().includes(w)).length;
      const negativeCount = sentiment.negative.filter(w => letra.toLowerCase().includes(w)).length;
      const emotionalCount = sentiment.emotional.filter(w => letra.toLowerCase().includes(w)).length;

      if (positiveCount > negativeCount) analysis += "‚Ä¢ Tono: Positivo/Optimista\n";
      else if (negativeCount > positiveCount) analysis += "‚Ä¢ Tono: Melanc√≥lico/Introspectivo\n";
      else analysis += "‚Ä¢ Tono: Neutro/Equilibrado\n";

      if (emotionalCount > 2) analysis += "‚Ä¢ Intensidad emocional: Alta\n";
      else analysis += "‚Ä¢ Intensidad emocional: Media\n";

      analysis += "‚Ä¢ Recomendaci√≥n: ";
      if (positiveCount > negativeCount) analysis += "Tempo alegre, instrumentaci√≥n brillante";
      else analysis += "Tempo lento, instrumentaci√≥n intimista";

      showToast(analysis, 'info');
      
      btn.disabled = false;
      btn.textContent = 'üìä Analizar Texto';
    }
    
    // Funciones de generaci√≥n musical con validaci√≥n
    async function generarMusica() {
      try {
        const esInstrumental = document.getElementById('modoInstrumental').checked;
        const letra = sanitizeInput(document.getElementById('letraCancion').value);
        const estilo = sanitizeInput(document.getElementById('promptEstilo').value);
        const preset = document.getElementById('presetGeneracion').value;
        
        if (!esInstrumental && !letra && !estilo) {
          showToast('Por favor ingresa una letra o prompt de estilo, o activa modo instrumental', 'warning');
          return;
        }
        
        if (esInstrumental && !estilo) {
          showToast('Por favor ingresa un prompt de estilo para el instrumental', 'warning');
          return;
        }
        
        const btn = document.getElementById('generarMusica');
        btn.disabled = true;
        btn.textContent = esInstrumental ? 'Generando instrumental...' : 'Generando canci√≥n...';
        
        // Llamada a API con manejo de errores
        const response = await fetch(`${API_BASE_URL}/api/songs/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: estilo,
            lyrics: letra,
            mode: esInstrumental ? 'instrumental' : 'original'
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.job_id) {
          showToast(`¬°Tarea encolada! ID: ${data.job_id}`, 'success');
          addLog(`üéµ Generando m√∫sica - Job ID: ${data.job_id}`);
        } else {
          showToast(esInstrumental ? '¬°Instrumental generado con √©xito!' : '¬°M√∫sica generada con √©xito!', 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error al generar m√∫sica: ' + error.message, 'error');
      } finally {
        const btn = document.getElementById('generarMusica');
        btn.disabled = false;
        btn.textContent = 'Generar M√∫sica';
      }
    }
    
    async function generarMusicaGhost() {
      try {
        const esInstrumental = document.getElementById('modoInstrumentalGhost').checked;
        const prompt = sanitizeInput(document.getElementById('promptGhostStudio').value);
        const preset = document.getElementById('presetGhost').value;
        const tags = sanitizeInput(document.getElementById('tagsEstilo').value);
        
        if (!prompt) {
          showToast('Por favor ingresa un prompt para Ghost Studio', 'warning');
          return;
        }
        
        const btn = document.getElementById('generarMusicaGhost');
        btn.disabled = true;
        btn.textContent = esInstrumental ? 'Procesando instrumental en Ghost Studio...' : 'Procesando en Ghost Studio...';
        
        const response = await fetch(`${API_BASE_URL}/api/songs/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: prompt,
            mode: esInstrumental ? 'instrumental' : 'original',
            preset: preset,
            tags: tags
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.job_id) {
          showToast(`¬°Ghost Studio procesando! ID: ${data.job_id}`, 'success');
          addLog(`üëª Ghost Studio procesando - Job ID: ${data.job_id}`);
        } else {
          showToast(esInstrumental ? '¬°Instrumental procesado por Ghost Studio!' : '¬°Maqueta procesada por Ghost Studio!', 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error en Ghost Studio: ' + error.message, 'error');
      } finally {
        const btn = document.getElementById('generarMusicaGhost');
        btn.disabled = false;
        btn.textContent = 'Generar M√∫sica';
      }
    }

    // System Status Functions
    async function checkSystemStatus() {
      try {
        // Check API
        const apiResponse = await fetch(`${API_BASE_URL}/api/health`);
        systemStatus.api = apiResponse.ok;

        // Check Celery (through backend endpoint if available)
        try {
          const celeryResponse = await fetch(`${API_BASE_URL}/api/celery-status`);
          systemStatus.celery = celeryResponse.ok;
        } catch {
          systemStatus.celery = false;
        }

        // Check Redis (through backend endpoint if available)
        try {
          const redisResponse = await fetch(`${API_BASE_URL}/api/redis-status`);
          systemStatus.redis = redisResponse.ok;
        } catch {
          systemStatus.redis = false;
        }

        updateStatusIndicators();
      } catch (error) {
        systemStatus.api = false;
        systemStatus.celery = false;
        systemStatus.redis = false;
        updateStatusIndicators();
      }
    }

    function updateStatusIndicators() {
      const indicators = {
        'api-status': systemStatus.api,
        'celery-status': systemStatus.celery,
        'redis-status': systemStatus.redis,
        'extension-status': systemStatus.extension
      };

      Object.entries(indicators).forEach(([id, status]) => {
        const element = document.getElementById(id);
        if (element) {
          element.className = `status-indicator ${status ? 'status-online' : 'status-offline'}`;
        }
      });
    }

    function refreshSystemStatus() {
      addLog('üîÑ Refrescando estado del sistema...');
      checkSystemStatus();
    }

    function addLog(message, type = 'info') {
      const logs = document.getElementById('extension-logs');
      if (logs) {
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEntry.className = `text-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'zinc'}-400`;
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
      }
    }

    function testExtensionConnection() {
      addLog('üîç Probando conexi√≥n de extensi√≥n...');
      window.postMessage({ type: 'BACKEND_PING', url: window.location.origin }, '*');
      
      setTimeout(() => {
        if (!systemStatus.extension) {
          addLog('‚ö†Ô∏è No hay respuesta de la extensi√≥n', 'error');
        }
      }, 2000);
    }

    function openExtensionPage() {
      window.open('chrome://extensions/', '_blank');
    }

    // Extension Communication
    window.addEventListener('message', (event) => {
      if (event.data.type === 'EXTENSION_PING') {
        systemStatus.extension = true;
        updateStatusIndicators();
        addLog('üîå ¬°Extensi√≥n conectada!', 'success');
        
        document.getElementById('ext-connection-status').textContent = 'Conectado';
        document.getElementById('ext-last-ping').textContent = new Date().toLocaleTimeString();
      }
    });

    // Auto-refresh extension status
    setInterval(() => {
      const lastPing = document.getElementById('ext-last-ping').textContent;
      if (lastPing !== 'Nunca') {
        const lastTime = new Date('1970-01-01 ' + lastPing);
        const now = new Date();
        const diff = (now.getTime() - lastTime.getTime()) / 1000;
        
        if (diff > 60) { // More than 1 minute since last ping
          systemStatus.extension = false;
          updateStatusIndicators();
          document.getElementById('ext-connection-status').textContent = 'Desconectado';
        }
      }
    }, 10000);
    
    // Sistema de notificaciones mejorado
    function showToast(message, type = 'info') {
      const toastArea = document.getElementById('toast-area');
      const toast = document.createElement('div');
      toast.className = `fixed top-24 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium max-w-sm transform transition-all duration-300 translate-x-full`;
      
      const colors = {
        'success': 'bg-green-600',
        'error': 'bg-red-600',
        'warning': 'bg-yellow-600',
        'info': 'bg-blue-600'
      };
      
      toast.classList.add(colors[type] || colors.info);
      
      // Crear nodo de texto seguro (sin innerHTML)
      const textNode = document.createTextNode(message);
      toast.appendChild(textNode);
      
      toastArea.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          if (toast.parentNode) {
            toastArea.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
    
    // Event listeners principales
    function setupEventListeners() {
      // Botones principales
      document.getElementById('testRapido').addEventListener('click', () => {
        showToast('Test R√°pido iniciado', 'info');
        checkSystemStatus();
      });
      
      document.getElementById('generarPreview').addEventListener('click', () => {
        showToast('Generando preview...', 'info');
      });
      
      document.getElementById('entrarEstudio').addEventListener('click', () => {
        showSection('generacion');
        document.querySelectorAll('.nav-tab').forEach(t => {
          t.classList.remove('tab-active');
          t.setAttribute('aria-selected', 'false');
        });
        const tab = document.querySelector('[data-section="generacion"]');
        tab.classList.add('tab-active');
        tab.setAttribute('aria-selected', 'true');
      });
      
      document.getElementById('entrarEstudioMain').addEventListener('click', () => {
        showSection('generacion');
        document.querySelectorAll('.nav-tab').forEach(t => {
          t.classList.remove('tab-active');
          t.setAttribute('aria-selected', 'false');
        });
        const tab = document.querySelector('[data-section="generacion"]');
        tab.classList.add('tab-active');
        tab.setAttribute('aria-selected', 'true');
      });
      
      document.getElementById('conocerUniverso').addEventListener('click', () => {
        showSection('home');
        window.scrollTo({ top: document.getElementById('home').offsetHeight, behavior: 'smooth' });
      });
      
      // Smart prompt buttons
      document.getElementById('generarLetraIA').addEventListener('click', generarLetraIA);
      document.getElementById('mejorarLetra').addEventListener('click', mejorarLetra);
      document.getElementById('promptInteligente').addEventListener('click', promptInteligente);
      document.getElementById('analizarTexto').addEventListener('click', analizarTexto);
      
      // Botones de generaci√≥n
      document.getElementById('generarMusica').addEventListener('click', generarMusica);
      document.getElementById('generarMusicaGhost').addEventListener('click', generarMusicaGhost);
      
      document.getElementById('verificarAPIs').addEventListener('click', async () => {
        showToast('Verificando conexiones de API...', 'info');
        await checkSystemStatus();
        if (systemStatus.api) {
          showToast('APIs conectadas correctamente', 'success');
        } else {
          showToast('Problemas de conectividad detectados', 'warning');
        }
      });
    }
    
    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', async () => {
      setupKnobs();
      setupSliders();
      setupNavigation();
      setupEventListeners();
      
      // Verificar sistema
      await checkSystemStatus();
      
      // Send message to potential extension
      window.postMessage({ type: 'BACKEND_PING', url: window.location.origin }, '*');
      
      setTimeout(() => {
        if (!systemStatus.extension) {
          addLog('‚ö†Ô∏è No hay respuesta de extensi√≥n. Verifica que est√© instalada.', 'warning');
        }
      }, 2000);
      
      // Mensaje de bienvenida
      setTimeout(() => {
        showToast('Bienvenido a Son1kVers3 - La Resistencia Sonora', 'success');
      }, 1000);
    });

    // ================================
    // SISTEMA DE AUTENTICACI√ìN
    // ================================

    // Variables globales de autenticaci√≥n
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');

    // Verificar autenticaci√≥n al cargar
    if (authToken) {
      verifyToken();
    }

    // Funci√≥n para mostrar modal de login
    function showLoginModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerForm').style.display = 'none';
    }

    // Funci√≥n para mostrar modal de registro
    function showRegisterModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    // Funci√≥n para cerrar modal
    function closeAuthModal() {
      document.getElementById('authModal').style.display = 'none';
    }

    // Funci√≥n de login
    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showToast('Por favor completa todos los campos', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          authToken = data.access_token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          updateAuthUI();
          closeAuthModal();
          showToast(`¬°Bienvenido ${currentUser.email}! Plan: ${currentUser.plan.toUpperCase()}`, 'success');
        } else {
          showToast(data.detail || 'Error en el login', 'error');
        }
      } catch (error) {
        showToast('Error de conexi√≥n', 'error');
        console.error('Login error:', error);
      }
    }

    // Funci√≥n de registro
    async function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const name = document.getElementById('registerName').value;

      if (!email || !password) {
        showToast('Email y contrase√±a son obligatorios', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password, name })
        });

        const data = await response.json();

        if (response.ok) {
          authToken = data.access_token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          updateAuthUI();
          closeAuthModal();
          showToast(`¬°Cuenta creada! Bienvenido ${currentUser.email}`, 'success');
        } else {
          showToast(data.detail || 'Error en el registro', 'error');
        }
      } catch (error) {
        showToast('Error de conexi√≥n', 'error');
        console.error('Register error:', error);
      }
    }

    // Funci√≥n de logout
    function logout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');
      updateAuthUI();
      showToast('Sesi√≥n cerrada', 'info');
    }

    // Verificar token v√°lido
    async function verifyToken() {
      if (!authToken) return;

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          currentUser = await response.json();
          updateAuthUI();
        } else {
          // Token inv√°lido
          logout();
        }
      } catch (error) {
        console.error('Token verification error:', error);
        logout();
      }
    }

    // Actualizar UI seg√∫n estado de autenticaci√≥n
    function updateAuthUI() {
      const authButtons = document.getElementById('authButtons');
      const userInfo = document.getElementById('userInfo');

      if (currentUser) {
        authButtons.style.display = 'none';
        userInfo.style.display = 'block';
        userInfo.innerHTML = `
          <div class="flex items-center space-x-4">
            <div class="text-right">
              <div class="text-sm font-medium">${currentUser.email}</div>
              <div class="text-xs text-neon">${currentUser.plan.toUpperCase()} - ${currentUser.daily_usage}/${currentUser.daily_limit} hoy</div>
            </div>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm">
              Salir
            </button>
          </div>
        `;
      } else {
        authButtons.style.display = 'block';
        userInfo.style.display = 'none';
      }
    }

    // Configurar eventos de autenticaci√≥n cuando se hace clic en "Entrar al Estudio"
    document.getElementById('entrarEstudio').addEventListener('click', () => {
      if (!currentUser) {
        showLoginModal();
      } else {
        // Usuario autenticado, ir al estudio
        const tabButton = document.querySelector('[data-section="estudio"]');
        if (tabButton) {
          tabButton.click();
        }
      }
    });

    document.getElementById('entrarEstudioMain').addEventListener('click', () => {
      if (!currentUser) {
        showLoginModal();
      } else {
        // Usuario autenticado, ir al estudio
        const tabButton = document.querySelector('[data-section="estudio"]');
        if (tabButton) {
          tabButton.click();
        }
      }
    });

    // ================================
    // PROTECCI√ìN OBLIGATORIA DE AUTENTICACI√ìN
    // ================================

    // Interceptar todos los clicks en tabs para requerir autenticaci√≥n
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const section = tab.getAttribute('data-section');
        
        // Secciones que requieren autenticaci√≥n
        const protectedSections = ['estudio', 'extension', 'archivo'];
        
        if (protectedSections.includes(section) && !currentUser) {
          e.preventDefault();
          e.stopPropagation();
          showLoginModal();
          showToast('Debes iniciar sesi√≥n para acceder a esta secci√≥n', 'error');
          return false;
        }
      });
    });

    // Proteger funciones de generaci√≥n
    const originalGenerateFunction = window.generarCancion;
    window.generarCancion = function() {
      if (!currentUser) {
        showLoginModal();
        showToast('Debes iniciar sesi√≥n para generar m√∫sica', 'error');
        return;
      }
      return originalGenerateFunction.apply(this, arguments);
    };

    // Proteger funci√≥n de env√≠o
    const originalSendFunction = window.enviarASuno;
    window.enviarASuno = function() {
      if (!currentUser) {
        showLoginModal();
        showToast('Debes iniciar sesi√≥n para enviar a Suno', 'error');
        return;
      }
      return originalSendFunction.apply(this, arguments);
    };

    // A√±adir headers de autorizaci√≥n a todas las requests API
    function makeAuthenticatedRequest(endpoint, options = {}) {
      if (!currentUser || !authToken) {
        showLoginModal();
        throw new Error('Autenticaci√≥n requerida');
      }

      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        },
        ...options
      };

      return fetch(`${API_BASE_URL}${endpoint}`, defaultOptions);
    }

    // Reemplazar funci√≥n global de fetch para endpoints protegidos
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      // Si es una llamada a API de songs, requerir autenticaci√≥n
      if (url.includes('/api/songs/') || url.includes('/api/auth/me')) {
        if (!currentUser || !authToken) {
          showLoginModal();
          return Promise.reject(new Error('Autenticaci√≥n requerida'));
        }
        
        // A√±adir token de autorizaci√≥n
        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${authToken}`
        };
      }
      
      return originalFetch.call(this, url, options);
    };

    // Verificar autenticaci√≥n al inicializar
    function checkAuthenticationOnLoad() {
      if (authToken) {
        verifyToken();
      } else {
        // Si no hay token, mostrar modal despu√©s de un breve delay
        setTimeout(() => {
          if (!currentUser) {
            showToast('¬°Bienvenido! Inicia sesi√≥n para usar todas las funciones', 'info');
          }
        }, 3000);
      }
    }

    // Ejecutar verificaci√≥n al cargar
    checkAuthenticationOnLoad();
  </script>

  <!-- Modal de Autenticaci√≥n -->
  <div id="authModal" style="display: none;" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="bg-zinc-900 p-8 rounded-xl border border-white/20 max-w-md w-full mx-4">
      
      <!-- Formulario de Login -->
      <div id="loginForm">
        <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesi√≥n</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="loginEmail" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="tu@email.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Contrase√±a</label>
            <input 
              type="password" 
              id="loginPassword" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
          <button 
            onclick="login()" 
            class="w-full bg-neon text-black py-3 rounded-lg font-semibold hover:bg-neon/90 transition"
          >
            Entrar
          </button>
          <div class="text-center">
            <button onclick="showRegisterModal()" class="text-neon hover:underline">
              ¬øNo tienes cuenta? Reg√≠strate
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de Registro -->
      <div id="registerForm" style="display: none;">
        <h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Nombre (opcional)</label>
            <input 
              type="text" 
              id="registerName" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="Tu nombre"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="registerEmail" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="tu@email.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Contrase√±a</label>
            <input 
              type="password" 
              id="registerPassword" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
          <button 
            onclick="register()" 
            class="w-full bg-neon text-black py-3 rounded-lg font-semibold hover:bg-neon/90 transition"
          >
            Crear Cuenta
          </button>
          <div class="text-center">
            <button onclick="showLoginModal()" class="text-neon hover:underline">
              ¬øYa tienes cuenta? Inicia sesi√≥n
            </button>
          </div>
        </div>
      </div>

      <button 
        onclick="closeAuthModal()" 
        class="absolute top-4 right-4 text-gray-400 hover:text-white"
      >
        ‚úï
      </button>
    </div>
  </div>

</body>
</html>