<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#00FFE7" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Son1kVers3" />
  <link rel="manifest" href="/manifest.json" />
  <title>Son1kVers3 ‚Äî La Resistencia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { 
            neon: '#00FFE7', 
            coal: '#0B0B0F', 
            haze: '#0f111a',
            'neon-purple': '#8b5cf6',
            'neon-blue': '#06b6d4' 
          },
          boxShadow: { glow: '0 0 40px rgba(0,255,231,.25)' }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: #0f111a !important; height: 100%; }
    body { background: #0f111a !important; color: #e4e4e7 !important; font-family: Inter, ui-sans-serif, system-ui !important; min-height: 100vh; }
    
    /* Layout System */
    .app-container {
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 1.5rem;
      padding: 1rem;
      min-height: calc(100vh - 80px);
    }
    
    .sidebar { 
      background: rgba(15, 17, 26, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      height: fit-content;
      position: sticky;
      top: 1rem;
    }
    
    .main-content {
      background: rgba(15, 17, 26, 0.9);
      border: 1px solid rgba(0, 255, 231, 0.2);
      border-radius: 16px;
      padding: 2rem;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 30px rgba(0, 255, 231, 0.1);
      min-height: 600px;
    }
    
    /* Navigation */
    .nav-bar {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
    }
    
    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e4e4e7;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }
    
    .nav-tab:hover {
      background: rgba(0, 255, 231, 0.1);
      border-color: rgba(0, 255, 231, 0.3);
    }
    
    .nav-tab.active {
      background: linear-gradient(45deg, #00FFE7, #8b5cf6);
      color: #000;
      border-color: #00FFE7;
    }
    
    /* Controls */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    
    .control-item {
      text-align: center;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .knob { 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      position: relative; 
      background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      cursor: pointer; 
      transition: all 0.2s ease;
      border: 3px solid #333;
      margin: 0 auto 0.5rem;
    }
    
    .knob:hover { 
      transform: scale(1.05); 
      box-shadow: 0 0 20px rgba(0,255,231,.3); 
    }
    
    .knob::after { 
      content: ''; 
      position: absolute; 
      left: 50%; 
      top: 10px; 
      width: 4px; 
      height: 20px; 
      background: #00FFE7; 
      border-radius: 2px; 
      transform: translateX(-50%) rotate(var(--rotation, 0deg)); 
      box-shadow: 0 0 8px rgba(0,255,231,.8); 
      transition: transform 0.1s ease;
    }
    
    /* Input Controls */
    .input-group {
      margin: 1rem 0;
    }
    
    .input-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #00FFE7;
    }
    
    .input-group textarea, .input-group input, .input-group select {
      width: 100%;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e4e4e7;
      font-size: 0.875rem;
      transition: border-color 0.2s ease;
    }
    
    .input-group textarea:focus, .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #00FFE7;
      box-shadow: 0 0 0 3px rgba(0, 255, 231, 0.1);
    }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-size: 0.875rem;
    }
    
    .btn-primary {
      background: #00FFE7;
      color: #000;
    }
    
    .btn-primary:hover {
      background: rgba(0, 255, 231, 0.9);
      box-shadow: 0 0 20px rgba(0, 255, 231, 0.3);
    }
    
    .btn-secondary {
      background: transparent;
      color: #e4e4e7;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #00FFE7;
    }
    
    /* Section Management */
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .sidebar {
        order: 2;
        position: static;
      }
      .main-content {
        order: 1;
      }
    }
    
    @media (max-width: 768px) {
      .nav-tabs {
        flex-wrap: wrap;
        gap: 0.25rem;
      }
      .nav-tab {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
      }
      .controls-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      .knob {
        width: 60px;
        height: 60px;
      }
      .knob::after {
        top: 8px;
        width: 3px;
        height: 16px;
      }
    }
    
    /* Utility Classes */
    .text-neon { color: #00FFE7 !important; }
    .text-purple { color: #8b5cf6 !important; }
    .text-zinc { color: #a1a1aa !important; }
    .bg-neon { background-color: #00FFE7 !important; }
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .text-center { text-align: center; }
    .font-bold { font-weight: 700; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mb-4 { margin-bottom: 1rem; }
    .p-4 { padding: 1rem; }
    .rounded { border-radius: 0.5rem; }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- NAVIGATION -->
    <nav class="nav-bar">
      <div class="nav-content">
        <div class="flex items-center space-x-3">
          <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #00FFE7, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 12px; font-weight: bold; color: black;">S3</span>
          </div>
          <span class="text-xl font-bold text-neon">SON1KVERS3</span>
        </div>
        
        <div class="nav-tabs">
          <button class="nav-tab active" data-section="home">Historia</button>
          <button class="nav-tab" data-section="ghost-studio">Ghost Studio</button>
          <button class="nav-tab" data-section="generacion">Generaci√≥n</button>
          <button class="nav-tab" data-section="archivo">Archivo</button>
          <button class="nav-tab" data-section="santuario">Santuario</button>
          <button class="nav-tab" data-section="planes">Planes</button>
        </div>
        
        <div class="flex items-center gap-3">
          <div class="text-sm">
            <div class="text-zinc">Plan: <span class="text-neon" id="userPlan">Free</span></div>
            <div class="text-zinc">Pistas: <span id="userTracks">0</span>/<span class="text-neon" id="userLimit">3</span></div>
          </div>
          <button id="loginBtn" class="btn btn-primary text-sm">Iniciar Sesi√≥n</button>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT GRID -->
    <div class="main-grid">
      <!-- LEFT SIDEBAR -->
      <div class="sidebar">
        <div class="space-y-4">
          <h3 class="text-neon font-bold text-lg">LA RESISTENCIA</h3>
          
          <!-- User Info -->
          <div class="space-y-2">
            <div class="text-sm">
              <div class="text-zinc">Estado: <span class="text-neon">Activo</span></div>
              <div class="text-zinc">Sesi√≥n: <span class="text-neon">Conectado</span></div>
            </div>
          </div>
          
          <!-- Audio Visualizer -->
          <div class="p-4 bg-black/30 rounded">
            <h4 class="text-neon text-sm font-bold mb-2">Visualizador</h4>
            <canvas id="visualizerCanvas" width="200" height="60" style="width: 100%; height: 60px; background: rgba(0,0,0,0.5); border-radius: 4px;"></canvas>
          </div>
          
          <!-- System Status -->
          <div class="p-4 bg-black/30 rounded">
            <h4 class="text-neon text-sm font-bold mb-2">Sistema</h4>
            <div class="space-y-1 text-xs">
              <div class="flex justify-between">
                <span>NOV4-IX Engine:</span>
                <span class="text-green-400">‚óè</span>
              </div>
              <div class="flex justify-between">
                <span>Resistencia AI:</span>
                <span class="text-green-400">‚óè</span>
              </div>
              <div class="flex justify-between">
                <span>Storage:</span>
                <span class="text-green-400">‚óè</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER CONTENT -->
      <div class="main-content">
        <!-- HOME SECTION -->
        <section id="home" class="section active">
          <div class="text-center space-y-4">
            <div class="space-y-2">
              <p class="text-sm text-zinc uppercase tracking-wider">LA RESISTENCIA</p>
              <h1 class="text-3xl md:text-4xl font-bold">
                Lo imperfecto tambi√©n<br>
                <span class="text-neon">es sagrado</span>
              </h1>
              <h2 class="text-lg text-zinc">
                Componer con alma en un mundo de m√°quinas.
              </h2>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 justify-center mt-6">
              <button id="entrarEstudio" class="btn btn-primary">Entrar al Estudio</button>
              <button id="conocerUniverso" class="btn btn-secondary" data-clicks="0">Conocer el Universo</button>
            </div>
            
            <p class="text-sm text-zinc max-w-lg mx-auto mt-4">
              Genera m√∫sica, clona voces cantadas, mezcla con calidad de estudio y guarda tu proceso en un archivo vivo. Bienvenido al Estudio Fantasma.
            </p>
          </div>
          
          <!-- Expression Controls -->
          <div class="mt-8">
            <h3 class="text-lg font-bold text-center mb-4">Controles de Expresividad</h3>
            <div class="controls-grid">
              <div class="control-item">
                <div class="knob" data-knob="expresividad" data-value="75"></div>
                <p class="text-sm text-zinc">Expresividad</p>
                <p class="text-xs text-neon" id="expresividadDisplay">75%</p>
              </div>
              <div class="control-item">
                <div class="knob" data-knob="creatividad" data-value="60"></div>
                <p class="text-sm text-zinc">Creatividad</p>
                <p class="text-xs text-neon" id="creatividadDisplay">60%</p>
              </div>
              <div class="control-item">
                <div class="knob" data-knob="precision" data-value="80"></div>
                <p class="text-sm text-zinc">Precisi√≥n</p>
                <p class="text-xs text-neon" id="precisionDisplay">80%</p>
              </div>
            </div>
          </div>
        </section>

        <!-- GENERATION SECTION -->
        <section id="generacion" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Generaci√≥n Musical</h2>
            
            <div class="input-group">
              <label for="letraCancion">Letra de la canci√≥n</label>
              <textarea id="letraCancion" rows="4" placeholder="Escribe la letra de tu canci√≥n aqu√≠..."></textarea>
            </div>
            
            <div class="input-group">
              <label for="promptEstilo">Prompt de estilo</label>
              <input type="text" id="promptEstilo" placeholder="Ej: rock alternativo, guitarra el√©ctrica, bater√≠a potente">
            </div>
            
            <div class="input-group">
              <label for="presetGeneracion">Preset de generaci√≥n</label>
              <select id="presetGeneracion">
                <option value="profesional">Profesional</option>
                <option value="experimental">Experimental</option>
                <option value="clasico">Cl√°sico</option>
                <option value="moderno">Moderno</option>
              </select>
            </div>
            
            <div class="text-center">
              <button id="generarMusica" class="btn btn-primary">üéµ Generar M√∫sica</button>
            </div>
            
            <!-- Generation Controls -->
            <div class="controls-grid mt-6">
              <div class="control-item">
                <div class="knob" data-knob="afinacion" data-value="60"></div>
                <p class="text-sm text-zinc">Afinaci√≥n</p>
                <p class="text-xs text-neon" id="afinacionDisplay">60%</p>
              </div>
              <div class="control-item">
                <div class="knob" data-knob="expresividad-gen" data-value="75"></div>
                <p class="text-sm text-zinc">Expresividad</p>
                <p class="text-xs text-neon" id="expresividadGenDisplay">75%</p>
              </div>
            </div>
          </div>
        </section>

        <!-- GHOST STUDIO SECTION -->
        <section id="ghost-studio" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Ghost Studio</h2>
            <p class="text-center text-zinc">Transformaci√≥n avanzada de audio con IA</p>
            
            <div class="input-group">
              <label for="audioFile">Subir archivo de audio</label>
              <input type="file" id="audioFile" accept="audio/*">
            </div>
            
            <div class="input-group">
              <label for="transformationType">Tipo de transformaci√≥n</label>
              <select id="transformationType">
                <option value="vocal-clone">Clonaci√≥n vocal</option>
                <option value="style-transfer">Transferencia de estilo</option>
                <option value="mastering">Masterizaci√≥n</option>
                <option value="noise-reduction">Reducci√≥n de ruido</option>
              </select>
            </div>
            
            <div class="text-center">
              <button id="transformAudio" class="btn btn-primary">üéõÔ∏è Transformar Audio</button>
            </div>
          </div>
        </section>

        <!-- ARCHIVE SECTION -->
        <section id="archivo" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">El Archivo</h2>
            <p class="text-center text-zinc">Tu m√∫sica generada</p>
            
            <div class="text-center mb-4">
              <button onclick="loadTracks()" class="px-4 py-2 bg-neon text-black rounded font-medium hover:bg-neon/80 transition-colors">
                üîÑ Cargar Tracks
              </button>
              <button onclick="testConnection()" class="ml-2 px-4 py-2 bg-zinc-700 text-white rounded font-medium hover:bg-zinc-600 transition-colors">
                üß™ Probar Conexi√≥n
              </button>
            </div>
            
            <div id="tracksList" class="space-y-4">
              <div class="p-4 bg-black/30 rounded">
                <p class="text-zinc">Cargando tracks...</p>
                <p class="text-sm text-zinc">Haz clic en "Cargar Tracks" para ver tu m√∫sica.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- SANCTUARY SECTION -->
        <section id="santuario" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Santuario</h2>
            <p class="text-center text-zinc">Configuraci√≥n y ajustes avanzados</p>
            
            <div class="space-y-4">
              <div class="input-group">
                <label for="aiModel">Modelo de IA</label>
                <select id="aiModel">
                  <option value="suno-v3">Suno v3</option>
                  <option value="suno-v2">Suno v2</option>
                </select>
              </div>
              
              <div class="input-group">
                <label for="outputQuality">Calidad de salida</label>
                <select id="outputQuality">
                  <option value="high">Alta (320kbps)</option>
                  <option value="medium">Media (192kbps)</option>
                  <option value="low">Baja (128kbps)</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- PLANS SECTION -->
        <section id="planes" class="section">
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-center">Planes de Suscripci√≥n</h2>
            
            <div class="grid md:grid-cols-3 gap-4">
              <div class="p-4 border border-white/20 rounded">
                <h3 class="text-lg font-bold text-neon">Free</h3>
                <p class="text-2xl font-bold">$0<span class="text-sm">/mes</span></p>
                <ul class="text-sm text-zinc space-y-1 mt-4">
                  <li>‚úì 3 pistas por mes</li>
                  <li>‚úì Calidad est√°ndar</li>
                  <li>‚úì Funciones b√°sicas</li>
                </ul>
              </div>
              
              <div class="p-4 border border-neon rounded bg-neon/10">
                <h3 class="text-lg font-bold text-neon">Pro</h3>
                <p class="text-2xl font-bold">$10<span class="text-sm">/mes</span></p>
                <ul class="text-sm text-zinc space-y-1 mt-4">
                  <li>‚úì 50 pistas por mes</li>
                  <li>‚úì Calidad premium</li>
                  <li>‚úì Ghost Studio incluido</li>
                  <li>‚úì Sin marca de agua</li>
                </ul>
              </div>
              
              <div class="p-4 border border-purple/50 rounded">
                <h3 class="text-lg font-bold text-purple">Enterprise</h3>
                <p class="text-2xl font-bold">$50<span class="text-sm">/mes</span></p>
                <ul class="text-sm text-zinc space-y-1 mt-4">
                  <li>‚úì 500 pistas por mes</li>
                  <li>‚úì Calidad ultra</li>
                  <li>‚úì API access</li>
                  <li>‚úì Soporte prioritario</li>
                </ul>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="sidebar">
        <div class="space-y-4">
          <h3 class="text-neon font-bold text-lg">Asistente IA</h3>
          
          <!-- AI Chat -->
          <div class="p-4 bg-black/30 rounded">
            <div id="chatMessages" class="space-y-2 mb-4 h-48 overflow-y-auto">
              <div class="text-sm text-zinc">
                <span class="text-neon">IA:</span> ¬°Hola! Soy tu asistente musical. ¬øEn qu√© puedo ayudarte hoy?
              </div>
            </div>
            <div class="flex gap-2">
              <input type="text" id="chatInput" placeholder="Pregunta algo..." class="flex-1 text-sm p-2 bg-black/50 border border-white/20 rounded">
              <button id="sendChat" class="btn btn-primary text-sm">Enviar</button>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="space-y-2">
            <h4 class="text-neon text-sm font-bold">Acciones R√°pidas</h4>
            <button class="btn btn-secondary w-full text-sm">üí° Generar Letra</button>
            <button class="btn btn-secondary w-full text-sm">üéº Sugerir Acordes</button>
            <button class="btn btn-secondary w-full text-sm">üé® Inspiraci√≥n Musical</button>
          </div>
          
          <!-- Recent Activity -->
          <div class="p-4 bg-black/30 rounded">
            <h4 class="text-neon text-sm font-bold mb-2">Actividad Reciente</h4>
            <div class="space-y-1 text-xs text-zinc">
              <div>‚Ä¢ Sistema iniciado</div>
              <div>‚Ä¢ Conectado a Suno API</div>
              <div>‚Ä¢ Listo para generar</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENHANCED MUSIC PLAYER (Fixed Position) -->
  <div id="musicPlayer" class="hidden fixed bottom-4 left-4 right-4 bg-black/90 backdrop-blur-xl border border-white/20 rounded-lg p-4 z-50">
    <!-- Track Info -->
    <div class="flex items-center gap-4 mb-3">
      <div class="flex items-center gap-3">
        <button id="playBtn" class="w-10 h-10 bg-neon text-black rounded-full flex items-center justify-center hover:bg-cyan-300 transition-colors">
          ‚ñ∂
        </button>
        <button id="pauseBtn" class="w-10 h-10 bg-neon text-black rounded-full flex items-center justify-center hover:bg-cyan-300 transition-colors hidden">
          ‚è∏
        </button>
      </div>
      <div class="flex-1">
        <div class="text-sm font-bold text-white" id="trackTitle">T√≠tulo de la pista</div>
        <div class="text-xs text-zinc" id="trackArtist">Generado por Son1kVers3</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="downloadBtn" class="btn btn-secondary text-sm">‚¨á Descargar</button>
        <button id="closePlayer" class="text-zinc hover:text-neon cursor-pointer">‚úï</button>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="mb-3">
      <div class="flex items-center gap-2 text-xs text-zinc">
        <span id="currentTime">0:00</span>
        <div class="flex-1 bg-gray-700 rounded-full h-1 cursor-pointer" id="progressBar">
          <div class="bg-neon h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <span id="duration">0:00</span>
      </div>
    </div>
    
    <!-- Volume Control -->
    <div class="flex items-center gap-2">
      <span class="text-xs text-zinc">üîä</span>
      <input type="range" id="volumeSlider" min="0" max="100" value="70" class="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
      <span class="text-xs text-zinc" id="volumeDisplay">70%</span>
    </div>
    
    <!-- Hidden Audio Element -->
    <audio id="audioPlayer" preload="metadata"></audio>
  </div>

  <!-- TOAST NOTIFICATIONS -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Global variables
    let currentSection = 'home';
    let userSession = {
      isLoggedIn: false,
      username: null,
      plan: 'free',
      tracksUsed: 0,
      tracksLimit: 3,
      token: null,
      user_id: 'anonymous',
      credits: 0,
      remaining_generations: 3
    };
    
    const API_BASE_URL = window.location.origin;
    
    // Funci√≥n para mapear presets a modelos
    function getModelFromPreset(preset) {
      const presetModelMap = {
        'profesional': 'suno',
        'experimental': 'riffusion',
        'basico': 'nuro',
        'avanzado': 'suno'
      };
      return presetModelMap[preset] || 'nuro';
    }

    // Funci√≥n para actualizar informaci√≥n del usuario
    async function updateUserInfo() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/user/usage?user_id=${userSession.user_id}&user_tier=${userSession.plan}`);
        const data = await response.json();
        
        userSession.credits = data.credits_used || 0;
        userSession.remaining_generations = data.remaining_generations || 0;
        
        updateUserStats();
      } catch (error) {
        console.error('Error actualizando info del usuario:', error);
      }
    }
    
    // Load existing tracks
    async function loadTracks() {
      console.log('üéµ Cargando tracks...');
      try {
        const response = await fetch(`${API_BASE_URL}/api/tracks`);
        console.log('üì° Respuesta API:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Datos recibidos:', data);
        
        const tracksList = document.getElementById('tracksList');
        if (!tracksList) {
          console.error('‚ùå Elemento tracksList no encontrado');
          return;
        }
        
        if (data.tracks && data.tracks.length > 0) {
          console.log(`‚úÖ Cargando ${data.tracks.length} tracks`);
          tracksList.innerHTML = '';
          
          data.tracks.forEach((track, index) => {
            console.log(`üéµ Track ${index + 1}:`, track.title);
            const trackElement = document.createElement('div');
            trackElement.className = 'p-4 bg-black/30 rounded border border-zinc-800 hover:border-neon/50 transition-colors mb-2';
            trackElement.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-white">${track.title}</h3>
                  <p class="text-sm text-zinc-400 mt-1">${track.prompt}</p>
                  <p class="text-xs text-zinc-500 mt-1">${new Date(track.created_at).toLocaleString()}</p>
                </div>
                <div class="flex items-center space-x-2">
                  <button onclick="playTrack('${track.id}')" class="px-3 py-1 bg-neon text-black rounded text-sm font-medium hover:bg-neon/80 transition-colors">
                    ‚ñ∂Ô∏è Reproducir
                  </button>
                  <button onclick="downloadTrack('${track.id}')" class="px-3 py-1 bg-zinc-700 text-white rounded text-sm font-medium hover:bg-zinc-600 transition-colors">
                    üì• Descargar
                  </button>
                </div>
              </div>
            `;
            tracksList.appendChild(trackElement);
          });
        } else {
          console.log('‚ÑπÔ∏è No hay tracks disponibles');
          tracksList.innerHTML = `
            <div class="p-4 bg-black/30 rounded">
              <p class="text-zinc">No hay pistas guardadas a√∫n.</p>
              <p class="text-sm text-zinc">Genera tu primera canci√≥n para comenzar tu archivo.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('‚ùå Error cargando tracks:', error);
        const tracksList = document.getElementById('tracksList');
        if (tracksList) {
          tracksList.innerHTML = `
            <div class="p-4 bg-red-900/30 rounded border border-red-500">
              <p class="text-red-400">Error cargando pistas: ${error.message}</p>
              <p class="text-xs text-red-300 mt-2">Revisa la consola para m√°s detalles</p>
            </div>
          `;
        }
      }
    }
    
    // Play track function
    function playTrack(trackId) {
      const audio = document.getElementById('audioPlayer');
      audio.src = `${API_BASE_URL}/api/tracks/${trackId}/audio`;
      audio.play();
      showToast('Reproduciendo pista...', 'info');
    }
    
    // Download track function
    function downloadTrack(trackId) {
      const link = document.createElement('a');
      link.href = `${API_BASE_URL}/api/tracks/${trackId}/audio`;
      link.download = `track_${trackId}.mp3`;
      link.click();
      showToast('Descargando pista...', 'info');
    }
    
    // Test connection function
    async function testConnection() {
      try {
        console.log('üß™ Probando conexi√≥n...');
        const response = await fetch(`${API_BASE_URL}/api/health`);
        const data = await response.json();
        
        console.log('‚úÖ Conexi√≥n exitosa:', data);
        showToast(`‚úÖ Servidor funcionando: ${data.status}`, 'success');
        
        // Mostrar informaci√≥n del servidor
        const tracksList = document.getElementById('tracksList');
        tracksList.innerHTML = `
          <div class="p-4 bg-green-900/30 rounded border border-green-500">
            <p class="text-green-400">‚úÖ Conexi√≥n exitosa</p>
            <p class="text-sm text-green-300">Servidor: ${data.status}</p>
            <p class="text-sm text-green-300">Tracks disponibles: ${data.tracks_available}</p>
            <p class="text-sm text-green-300">Ollama: ${data.ollama_available ? 'S√≠' : 'No'}</p>
            <button onclick="loadTracks()" class="mt-2 px-3 py-1 bg-green-600 text-white rounded text-sm">
              üîÑ Cargar Tracks Ahora
            </button>
          </div>
        `;
        
      } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        
        const tracksList = document.getElementById('tracksList');
        tracksList.innerHTML = `
          <div class="p-4 bg-red-900/30 rounded border border-red-500">
            <p class="text-red-400">‚ùå Error de conexi√≥n</p>
            <p class="text-sm text-red-300">${error.message}</p>
          </div>
        `;
      }
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      setupNavigation();
      setupKnobs();
      setupAudioVisualizer();
      setupEventListeners();
      updateUserStats();
      loadTracks(); // Cargar tracks existentes
      updateUserInfo(); // Cargar informaci√≥n de cr√©ditos
      setupPIXELIntegration(); // Configurar integraci√≥n con PIXEL
    });

    // Setup PIXEL integration with generators
    function setupPIXELIntegration() {
      // Add PIXEL action buttons to chat
      const chatContainer = document.getElementById('chatMessages');
      if (chatContainer) {
        const actionButtons = document.createElement('div');
        actionButtons.id = 'pixelActions';
        actionButtons.className = 'hidden mt-4 p-3 bg-gray-800 rounded-lg';
        actionButtons.innerHTML = `
          <div class="text-sm text-neon mb-2">ü§ñ PIXEL sugiere:</div>
          <div class="flex gap-2 flex-wrap">
            <button onclick="pixelGeneratePrompt()" class="px-3 py-1 bg-cyan-600 text-white rounded text-xs hover:bg-cyan-700">
              üéõÔ∏è Generar Prompt
            </button>
            <button onclick="pixelGenerateLyrics()" class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700">
              üéµ Generar Letras
            </button>
            <button onclick="pixelGenerateMusic()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
              üé∂ Generar M√∫sica
            </button>
            <button onclick="applyRupertNeveProcessing()" class="px-3 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">
              üéõÔ∏è Rupert Neve
            </button>
          </div>
        `;
        chatContainer.appendChild(actionButtons);
      }
    }

    // PIXEL action functions
    async function pixelGeneratePrompt() {
      const chatInput = document.getElementById('chatInput');
      const currentMessage = chatInput.value.trim();
      
      if (!currentMessage) {
        showToast('Escribe algo en el chat para que PIXEL genere un prompt', 'warning');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/generate-prompt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_input: currentMessage,
            genre: 'synthwave',
            mood: 'energ√©tico'
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          // Fill the prompt field
          const promptField = document.getElementById('promptEstilo');
          if (promptField) {
            promptField.value = data.generated_prompt;
            showToast('‚úÖ PIXEL gener√≥ un prompt optimizado', 'success');
          }
        } else {
          showToast('‚ùå Error generando prompt con PIXEL', 'error');
        }
      } catch (error) {
        console.error('PIXEL prompt error:', error);
        showToast('‚ùå Error conectando con PIXEL', 'error');
      }
    }

    async function pixelGenerateLyrics() {
      const chatInput = document.getElementById('chatInput');
      const currentMessage = chatInput.value.trim();
      
      if (!currentMessage) {
        showToast('Escribe algo en el chat para que PIXEL genere letras', 'warning');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/generate-lyrics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_words: currentMessage,
            genre: 'synthwave',
            mood: 'energ√©tico',
            structure: 'verse-chorus-verse-chorus-bridge-chorus'
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success' || data.generated_lyrics) {
          // Fill the lyrics field
          const lyricsField = document.getElementById('letraCancion');
          if (lyricsField) {
            lyricsField.value = data.generated_lyrics;
            showToast('‚úÖ PIXEL gener√≥ letras √©picas', 'success');
          }
        } else {
          showToast('‚ùå Error generando letras con PIXEL', 'error');
        }
      } catch (error) {
        console.error('PIXEL lyrics error:', error);
        showToast('‚ùå Error conectando con PIXEL', 'error');
      }
    }

    async function pixelGenerateMusic() {
      const chatInput = document.getElementById('chatInput');
      const currentMessage = chatInput.value.trim();
      
      if (!currentMessage) {
        showToast('Escribe algo en el chat para que PIXEL genere m√∫sica', 'warning');
        return;
      }
      
      // Fill the prompt field and trigger generation
      const promptField = document.getElementById('promptEstilo');
      if (promptField) {
        promptField.value = currentMessage;
        showToast('‚úÖ PIXEL configur√≥ el prompt, generando m√∫sica...', 'success');
        
        // Trigger music generation
        setTimeout(() => {
          generarMusica();
        }, 1000);
      }
    }

    // Aplicar postprocesos Rupert Neve
    async function applyRupertNeveProcessing() {
      const currentTrack = getCurrentTrack();
      
      if (!currentTrack) {
        showToast('No hay track cargado para procesar', 'warning');
        return;
      }
      
      try {
        showToast('üéõÔ∏è Aplicando postprocesos Rupert Neve...', 'info');
        
        const response = await fetch(`${API_BASE_URL}/api/postprocess/rupert-neve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            track_id: currentTrack.id,
            title: currentTrack.title,
            audio_url: currentTrack.audio_url,
            duration: currentTrack.duration,
            user_tier: userSession.plan
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          showToast('‚úÖ Postprocesos Rupert Neve aplicados exitosamente', 'success');
          
          // Mostrar detalles del procesamiento
          const processingDetails = data.processing_details;
          const processingChain = data.processing_chain;
          
          showToast(`üéõÔ∏è Cadena de procesamiento: ${processingChain.join(' ‚Üí ')}`, 'info');
          
          // Actualizar el reproductor con el track procesado
          const processedTrack = data.processed_track;
          showMusicPlayer(processedTrack);
          
        } else {
          showToast('‚ùå Error aplicando postprocesos Rupert Neve', 'error');
        }
        
      } catch (error) {
        console.error('Error aplicando postprocesos:', error);
        showToast('‚ùå Error conectando con el sistema de postprocesos', 'error');
      }
    }

    // Obtener track actual (funci√≥n auxiliar)
    function getCurrentTrack() {
      // Esta funci√≥n deber√≠a retornar el track actualmente cargado
      // Por ahora retornamos null, pero en una implementaci√≥n real
      // esto vendr√≠a del estado del reproductor
      return null;
    }
    
    // Navigation
    function setupNavigation() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const targetSection = e.target.dataset.section;
          showSection(targetSection);
          
          // Update active tab
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
        });
      });
    }
    
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show target section
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.add('active');
        currentSection = sectionName;
      }
    }
    
    // Knob controls
    function setupKnobs() {
      document.querySelectorAll('.knob').forEach(knob => {
        let isDragging = false;
        let startAngle = 0;
        let currentValue = parseInt(knob.dataset.value) || 50;
        
        updateKnobRotation(knob, currentValue);
        
        knob.addEventListener('mousedown', startDrag);
        knob.addEventListener('touchstart', startDrag);
        
        function startDrag(e) {
          isDragging = true;
          const rect = knob.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
          const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
          
          startAngle = Math.atan2(clientY - centerY, clientX - centerX);
          
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
          document.addEventListener('touchmove', drag);
          document.addEventListener('touchend', stopDrag);
          
          e.preventDefault();
        }
        
        function drag(e) {
          if (!isDragging) return;
          
          const rect = knob.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
          const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
          
          const currentAngle = Math.atan2(clientY - centerY, clientX - centerX);
          const deltaAngle = currentAngle - startAngle;
          
          currentValue += (deltaAngle * 180 / Math.PI) / 3;
          currentValue = Math.max(0, Math.min(100, currentValue));
          
          updateKnobRotation(knob, currentValue);
          updateKnobDisplay(knob.dataset.knob, currentValue);
          
          startAngle = currentAngle;
          e.preventDefault();
        }
        
        function stopDrag() {
          isDragging = false;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', drag);
          document.removeEventListener('touchend', stopDrag);
        }
      });
    }
    
    function updateKnobRotation(knob, value) {
      const rotation = (value / 100) * 270 - 135; // -135 to +135 degrees
      knob.style.setProperty('--rotation', rotation + 'deg');
    }
    
    function updateKnobDisplay(knobType, value) {
      const displays = {
        'expresividad': 'expresividadDisplay',
        'creatividad': 'creatividadDisplay', 
        'precision': 'precisionDisplay',
        'afinacion': 'afinacionDisplay',
        'expresividad-gen': 'expresividadGenDisplay'
      };
      
      const displayId = displays[knobType];
      if (displayId) {
        const display = document.getElementById(displayId);
        if (display) {
          display.textContent = Math.round(value) + '%';
        }
      }
    }
    
    // Audio visualizer
    function setupAudioVisualizer() {
      const canvas = document.getElementById('visualizerCanvas');
      const ctx = canvas.getContext('2d');
      
      // Simple animated visualizer
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw animated bars
        const barCount = 20;
        const barWidth = canvas.width / barCount;
        
        for (let i = 0; i < barCount; i++) {
          const height = Math.random() * canvas.height * 0.7 + 10;
          const x = i * barWidth;
          const y = canvas.height - height;
          
          const gradient = ctx.createLinearGradient(0, y, 0, canvas.height);
          gradient.addColorStop(0, '#00FFE7');
          gradient.addColorStop(1, '#8b5cf6');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, y, barWidth - 2, height);
        }
        
        requestAnimationFrame(animate);
      }
      
      animate();
    }
    
    // Event listeners
    function setupEventListeners() {
      // Generation button
      document.getElementById('generarMusica')?.addEventListener('click', generarMusica);
      
      // Studio entry buttons
      document.getElementById('entrarEstudio')?.addEventListener('click', () => showSection('generacion'));
      
      // Easter egg portal to son1k-ready terminal universe
      document.getElementById('conocerUniverso')?.addEventListener('click', activatePortal);
      
      // Login functionality
      document.getElementById('loginBtn')?.addEventListener('click', showLoginModal);
      
      // Chat functionality
      document.getElementById('sendChat')?.addEventListener('click', sendChatMessage);
      document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
    }
    
    // Music generation with credit system
    async function generarMusica() {
      if (!checkUserLimits()) return;
      
      const letra = document.getElementById('letraCancion').value;
      const estilo = document.getElementById('promptEstilo').value;
      const preset = document.getElementById('presetGeneracion').value;
      
      if (!letra && !estilo) {
        showToast('Por favor ingresa una letra o prompt de estilo', 'warning');
        return;
      }
      
      const btn = document.getElementById('generarMusica');
      btn.disabled = true;
      btn.textContent = 'Generando m√∫sica...';
      
      try {
        // Usar el nuevo endpoint con sistema de cr√©ditos
        const response = await fetch(`${API_BASE_URL}/api/generate-with-credits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: estilo || 'canci√≥n con letra personalizada',
            lyrics: letra || '',
            style: preset || 'profesional',
            user_id: userSession.user_id || 'anonymous',
            user_tier: userSession.plan || 'free',
            model: getModelFromPreset(preset),
            generate_lyrics: !letra, // Generar letras si no hay letra
            optimize_prompt: true
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success' && data.audio_url) {
          // Convert new API format to expected track format
          const track = {
            id: data.track_id,
            title: data.title,
            audio_url: data.audio_url,
            download_url: data.download_url,
            duration: data.duration,
            tags: data.style || 'profesional'
          };
          
          showToast('¬°M√∫sica generada con √©xito!', 'success');
          
          // Mostrar informaci√≥n de cr√©ditos consumidos
          if (data.credits_consumed) {
            showToast(`Cr√©ditos consumidos: ${data.credits_consumed}`, 'info');
          }
          
          // Mostrar informaci√≥n de postprocesos Rupert Neve
          if (data.post_processing) {
            showToast(`üéõÔ∏è Postprocesos Rupert Neve aplicados: SSL + Expresividad + Saturaci√≥n`, 'success');
          }
          
          if (data.translation_applied) {
            showToast(`Prompt optimizado autom√°ticamente: "${data.optimized_prompt}"`, 'info');
          }
          
          // Actualizar informaci√≥n del usuario
          updateUserInfo();
          
          userSession.tracksUsed++;
          updateUserStats();
          
          showMusicPlayer(track);
          loadTracks(); // Recargar lista de tracks
        } else {
          showToast('Error al generar m√∫sica: ' + (data.detail || data.error || 'Error desconocido'), 'error');
        }
      } catch (error) {
        showToast('Error al generar m√∫sica: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üéµ Generar M√∫sica';
      }
    }
    
    // User limits check with credit system
    function checkUserLimits() {
      // Verificar l√≠mites de generaciones mensuales
      if (userSession.remaining_generations === 0 && userSession.plan !== 'premium') {
        showToast('Has alcanzado tu l√≠mite mensual de generaciones. Actualiza tu plan para continuar.', 'warning');
        return false;
      }
      
      // Verificar l√≠mites de pistas (sistema legacy)
      if (userSession.tracksUsed >= userSession.tracksLimit) {
        showToast('Has alcanzado el l√≠mite de pistas para tu plan. Actualiza para continuar.', 'warning');
        return false;
      }
      
      return true;
    }
    
    // Update user stats
    function updateUserStats() {
      document.getElementById('userPlan').textContent = userSession.plan;
      document.getElementById('userTracks').textContent = userSession.tracksUsed;
      document.getElementById('userLimit').textContent = userSession.tracksLimit;
      
      // Actualizar informaci√≥n de cr√©ditos si los elementos existen
      const creditsElement = document.getElementById('userCredits');
      const remainingElement = document.getElementById('userRemaining');
      
      if (creditsElement) {
        creditsElement.textContent = userSession.credits;
      }
      if (remainingElement) {
        remainingElement.textContent = userSession.remaining_generations;
      }
    }
    
    // Enhanced Music player with full controls
    function showMusicPlayer(track) {
      const player = document.getElementById('musicPlayer');
      const audio = document.getElementById('audioPlayer');
      const title = document.getElementById('trackTitle');
      
      if (track.audio_url) {
        audio.src = track.audio_url;
        title.textContent = track.title || 'Nueva generaci√≥n';
        player.classList.remove('hidden');
        
        // Show success message
        showToast('üéµ Reproductor cargado - ¬°Disfruta tu m√∫sica!', 'success');
        
        // Setup player controls
        setupMusicPlayerControls();
        
        // Auto-play if possible
        audio.play().catch(e => {
          console.log('Auto-play blocked:', e);
          showToast('Haz clic en play para reproducir', 'info');
        });
      }
    }

    // Setup music player controls
    function setupMusicPlayerControls() {
      const audio = document.getElementById('audioPlayer');
      const playBtn = document.getElementById('playBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const progressBar = document.getElementById('progressBar');
      const volumeSlider = document.getElementById('volumeSlider');
      const currentTime = document.getElementById('currentTime');
      const duration = document.getElementById('duration');
      
      if (!audio) return;
      
      // Play/Pause functionality
      if (playBtn) {
        playBtn.addEventListener('click', () => {
          audio.play();
          playBtn.style.display = 'none';
          if (pauseBtn) pauseBtn.style.display = 'inline-block';
        });
      }
      
      if (pauseBtn) {
        pauseBtn.addEventListener('click', () => {
          audio.pause();
          pauseBtn.style.display = 'none';
          if (playBtn) playBtn.style.display = 'inline-block';
        });
      }
      
      // Progress bar
      if (progressBar) {
        audio.addEventListener('timeupdate', () => {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressBar.style.width = progress + '%';
          
          if (currentTime) {
            currentTime.textContent = formatTime(audio.currentTime);
          }
        });
        
        progressBar.addEventListener('click', (e) => {
          const rect = progressBar.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const width = rect.width;
          const clickTime = (clickX / width) * audio.duration;
          audio.currentTime = clickTime;
        });
      }
      
      // Volume control
      if (volumeSlider) {
        volumeSlider.addEventListener('input', (e) => {
          audio.volume = e.target.value / 100;
        });
      }
      
      // Duration display
      audio.addEventListener('loadedmetadata', () => {
        if (duration) {
          duration.textContent = formatTime(audio.duration);
        }
      });
    }
    
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Chat functionality with real AI
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const chatMessages = document.getElementById('chatMessages');
      
      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'text-sm';
      userMsg.innerHTML = `<span class="text-neon">T√∫:</span> ${message}`;
      chatMessages.appendChild(userMsg);
      
      // Show loading indicator
      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'text-sm text-zinc';
      loadingMsg.innerHTML = `<span class="text-neon">IA:</span> <span class="animate-pulse">Pensando...</span>`;
      chatMessages.appendChild(loadingMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      input.value = '';
      
      try {
        // Call backend AI assistant
        const response = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            context: 'musical_assistant',
            user_session: userSession
          })
        });
        
        const data = await response.json();
        
        // Remove loading message
        loadingMsg.remove();
        
        // Add AI response
        const aiMsg = document.createElement('div');
        aiMsg.className = 'text-sm text-zinc';
        aiMsg.innerHTML = `<span class="text-neon">IA:</span> ${data.response || 'Lo siento, no pude procesar tu mensaje.'}`;
        chatMessages.appendChild(aiMsg);
        
      } catch (error) {
        // Remove loading message and show error
        loadingMsg.remove();
        
        const errorMsg = document.createElement('div');
        errorMsg.className = 'text-sm text-zinc';
        errorMsg.innerHTML = `<span class="text-neon">IA:</span> Error de conexi√≥n. Usando respuesta local: ${generateLocalResponse(message)}`;
        chatMessages.appendChild(errorMsg);
      }
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Local fallback responses
    function generateLocalResponse(message) {
      const lowerMsg = message.toLowerCase();
      
      if (lowerMsg.includes('letra') || lowerMsg.includes('lyric')) {
        return '¬øTe ayudo a crear una letra? Puedo generar versos basados en tu tema o estado de √°nimo.';
      } else if (lowerMsg.includes('prompt') || lowerMsg.includes('estilo')) {
        return 'Puedo sugerir prompts musicales. ¬øQu√© g√©nero o mood tienes en mente?';
      } else if (lowerMsg.includes('acordes') || lowerMsg.includes('music')) {
        return 'Para sugerencias musicales, ¬øprefieres algo mel√≥dico, r√≠tmico o experimental?';
      } else if (lowerMsg.includes('generar') || lowerMsg.includes('crear')) {
        return '¬°Perfecto! ¬øQuieres que genere una letra, un prompt musical, o ambos?';
      } else {
        return `Interesante. Puedo ayudarte con letras, prompts musicales, o sugerencias creativas. ¬øEn qu√© te gustar√≠a que me enfoque?`;
      }
    }
    
    // Toast notifications
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      toast.className = `${colors[type]} text-white px-4 py-3 rounded shadow-lg`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }
    
    // Easter egg portal activation
    function activatePortal() {
      const btn = document.getElementById('conocerUniverso');
      let clicks = parseInt(btn.getAttribute('data-clicks') || '0');
      clicks++;
      btn.setAttribute('data-clicks', clicks.toString());
      
      const portalSequence = [
        'Conocer el Universo',
        '‚óØ Grietas se abren ‚óØ',
        '‚ö° Descifrando... ‚ö°',
        '‚ñ≥ Portal activado ‚ñ≥',
        'üåå Ingresando... üåå'
      ];
      
      if (clicks <= portalSequence.length) {
        btn.textContent = portalSequence[clicks - 1];
        
        if (clicks === 3) {
          // Start glitch effect
          btn.style.animation = 'glitch 0.5s infinite';
          document.body.style.filter = 'hue-rotate(180deg) contrast(1.2)';
        }
        
        if (clicks === 5) {
          // Portal activation sequence
          showToast('üåå Portal de la Resistencia activado...', 'info');
          setTimeout(() => {
            // Activate portal via API
            activateResistancePortal();
          }, 2000);
        }
      }
    }
    
    // Activate resistance portal via API
    async function activateResistancePortal() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/easter-eggs/portal`);
        const data = await response.json();
        
        if (data.status === 'success') {
          showToast(data.message, 'success');
          createTerminalPortal();
        }
      } catch (error) {
        console.error('Portal activation error:', error);
        createTerminalPortal(); // Fallback
      }
    }
    
    // Konami code easter egg
    let konamiCode = [];
    const konamiSequence = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65]; // ‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA
    
    document.addEventListener('keydown', (e) => {
      konamiCode.push(e.keyCode);
      if (konamiCode.length > konamiSequence.length) {
        konamiCode.shift();
      }
      
      if (konamiCode.join(',') === konamiSequence.join(',')) {
        activateKonamiCode();
        konamiCode = [];
      }
    });
    
    async function activateKonamiCode() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/easter-eggs/konami`);
        const data = await response.json();
        
        if (data.status === 'success') {
          showToast(data.message, 'success');
          
          // Activar modo desarrollador
          document.body.classList.add('developer-mode');
          
          // Mostrar herramientas de desarrollador
          showDeveloperTools();
        }
      } catch (error) {
        console.error('Konami code error:', error);
      }
    }
    
    function showDeveloperTools() {
      const devTools = document.createElement('div');
      devTools.id = 'developer-tools';
      devTools.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid #00FFE7;
        border-radius: 8px;
        padding: 10px;
        color: #00FFE7;
        font-family: monospace;
        font-size: 12px;
        z-index: 9999;
        max-width: 300px;
      `;
      
      devTools.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 10px;">üõ†Ô∏è Developer Tools</div>
        <div>Status: <span style="color: #00ff00;">Active</span></div>
        <div>Mode: <span style="color: #ffff00;">Resistance</span></div>
        <div>API: <span style="color: #00ff00;">Connected</span></div>
        <button onclick="toggleGlitchMode()" style="margin-top: 10px; padding: 5px 10px; background: #00FFE7; color: #000; border: none; border-radius: 4px; cursor: pointer;">‚ö° Glitch Mode</button>
        <button onclick="this.parentElement.remove()" style="margin-top: 5px; padding: 5px 10px; background: #ff4444; color: #fff; border: none; border-radius: 4px; cursor: pointer;">‚úï Close</button>
      `;
      
      document.body.appendChild(devTools);
    }
    
    async function toggleGlitchMode() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/easter-eggs/glitch`);
        const data = await response.json();
        
        if (data.status === 'success') {
          showToast(data.message, 'info');
          
          // Aplicar efectos glitch
          document.body.style.filter = 'hue-rotate(90deg) contrast(1.5) saturate(2)';
          document.body.style.animation = 'glitch 0.1s infinite';
          
          // Crear efecto de distorsi√≥n
          setTimeout(() => {
            document.body.style.filter = '';
            document.body.style.animation = '';
          }, 3000);
        }
      } catch (error) {
        console.error('Glitch mode error:', error);
      }
    }
    
    // Create terminal portal overlay
    function createTerminalPortal() {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(45deg, #020304, #0a1a17);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: #00ff95;
        font-family: monospace;
        animation: fadeIn 2s ease-in-out;
      `;
      
      overlay.innerHTML = `
        <div style="text-align: center; max-width: 600px; padding: 2rem;">
          <div style="font-size: 2rem; margin-bottom: 1rem;">
            ‚óØ‚ö° SON1KVERS3 ‚Äî TERMINAL ‚óØ‚ö°
          </div>
          <div style="margin-bottom: 2rem; color: #cde6e0; line-height: 1.6;">
            <div>[BOOTING] Accessing NODE // RESISTENCIA ‚Ä¶</div>
            <div>> Mensaje entrante: <span style="color: #00f6ff;">BELLA.exe</span></div>
            <div style="color: #ffcc00; margin-top: 1rem;">
              "Tu glitch es la chispa de la Liga del No Silencio."
            </div>
          </div>
          <div style="margin-bottom: 2rem; border: 1px dashed #135345; padding: 1rem; border-radius: 8px;">
            <div>La puerta solo se abre con una <span style="border: 1px solid #00f6ff; padding: 2px 8px; border-radius: 4px; color: #00f6ff;">demo real</span>.</div>
            <div style="margin-top: 1rem;">> ALMA_HIBRIDA ‚Äî elige un arquetipo:</div>
            <div style="margin-top: 0.5rem; color: #ff49c3;">[1] PIXEL [2] BELLA [3] NOVA [4] CIPHER</div>
          </div>
          <div style="color: #ffcc00; margin-bottom: 2rem;">
            "Lo imperfecto tambi√©n es sagrado."
          </div>
          <button id="portalEnter" style="
            background: linear-gradient(45deg, #00ff95, #00f6ff);
            color: #020304;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
          ">
            ‚óØ‚ö° DESPERTAR
          </button>
          <div style="margin-top: 1rem;">
            <button id="portalBack" style="
              background: transparent;
              color: #8fb3a9;
              border: 1px solid #0d3c31;
              padding: 8px 16px;
              border-radius: 4px;
              font-family: monospace;
              cursor: pointer;
            ">
              Regresar al Estudio
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Portal actions
      document.getElementById('portalEnter').addEventListener('click', () => {
        showToast('üåå Preparando acceso al Terminal...', 'info');
        // Here you would redirect to the son1k-ready terminal experience
        // window.location.href = 'https://son1k-ready.railway.app';
        overlay.innerHTML = `
          <div style="text-align: center; color: #00ff95;">
            <div style="font-size: 1.5rem; margin-bottom: 1rem;">
              ‚óØ‚ö° PRONTO DISPONIBLE ‚óØ‚ö°
            </div>
            <div style="color: #cde6e0; margin-bottom: 2rem;">
              El Terminal de la Resistencia est√° siendo construido...<br>
              Son1k-Ready se desplegar√° pr√≥ximamente.
            </div>
            <div style="color: #ffcc00;">
              "La revoluci√≥n musical viene en c√≥digo."
            </div>
          </div>
        `;
        setTimeout(() => overlay.remove(), 3000);
      });
      
      document.getElementById('portalBack').addEventListener('click', () => {
        overlay.remove();
        document.body.style.filter = '';
        const btn = document.getElementById('conocerUniverso');
        btn.textContent = 'Conocer el Universo';
        btn.setAttribute('data-clicks', '0');
        btn.style.animation = '';
      });
    }
    
    // Login system
    function showLoginModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: rgba(15, 17, 26, 0.95);
          border: 1px solid rgba(0, 255, 231, 0.3);
          border-radius: 16px;
          padding: 2rem;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 0 30px rgba(0, 255, 231, 0.2);
        ">
          <h2 style="color: #00FFE7; text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem;">
            Acceso a la Resistencia
          </h2>
          
          <div id="loginTabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
            <button id="loginTab" class="btn btn-primary" style="flex: 1;">Iniciar Sesi√≥n</button>
            <button id="registerTab" class="btn btn-secondary" style="flex: 1;">Registrarse</button>
          </div>
          
          <form id="authForm">
            <div class="input-group">
              <label for="authUsername">Usuario</label>
              <input type="text" id="authUsername" placeholder="Tu nombre de resistente" required>
            </div>
            
            <div class="input-group">
              <label for="authEmail">Email</label>
              <input type="email" id="authEmail" placeholder="resistente@son1kvers3.com" required>
            </div>
            
            <div class="input-group">
              <label for="authPassword">Contrase√±a</label>
              <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            
            <div id="registerFields" style="display: none;">
              <div class="input-group">
                <label for="authConfirmPassword">Confirmar Contrase√±a</label>
                <input type="password" id="authConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>
              
              <div class="input-group">
                <label for="authArchetype">Arquetipo de la Resistencia</label>
                <select id="authArchetype">
                  <option value="pixel">PIXEL - Artista Digital</option>
                  <option value="bella">BELLA - Alma H√≠brida</option>
                  <option value="nova">NOVA - Innovador S√≥nico</option>
                  <option value="cipher">CIPHER - Descifrador</option>
                </select>
              </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button type="submit" id="authSubmit" class="btn btn-primary" style="flex: 1;">
                Iniciar Sesi√≥n
              </button>
              <button type="button" id="closeAuth" class="btn btn-secondary">
                Cancelar
              </button>
            </div>
          </form>
          
          <div style="text-align: center; margin-top: 1rem; color: #a1a1aa; font-size: 0.875rem;">
            "Lo imperfecto tambi√©n es sagrado"
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      let isRegisterMode = false;
      
      // Tab switching
      document.getElementById('loginTab').addEventListener('click', () => {
        isRegisterMode = false;
        document.getElementById('loginTab').className = 'btn btn-primary';
        document.getElementById('registerTab').className = 'btn btn-secondary';
        document.getElementById('registerFields').style.display = 'none';
        document.getElementById('authSubmit').textContent = 'Iniciar Sesi√≥n';
      });
      
      document.getElementById('registerTab').addEventListener('click', () => {
        isRegisterMode = true;
        document.getElementById('loginTab').className = 'btn btn-secondary';
        document.getElementById('registerTab').className = 'btn btn-primary';
        document.getElementById('registerFields').style.display = 'block';
        document.getElementById('authSubmit').textContent = 'Registrarse';
      });
      
      // Form submission
      document.getElementById('authForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('authUsername').value;
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        
        if (isRegisterMode) {
          const confirmPassword = document.getElementById('authConfirmPassword').value;
          const archetype = document.getElementById('authArchetype').value;
          
          if (password !== confirmPassword) {
            showToast('Las contrase√±as no coinciden', 'error');
            return;
          }
          
          await performRegistration(username, email, password, archetype);
        } else {
          await performLogin(email, password);
        }
        
        modal.remove();
      });
      
      // Close modal
      document.getElementById('closeAuth').addEventListener('click', () => {
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
    
    async function performLogin(email, password) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          userSession.isLoggedIn = true;
          userSession.username = data.user.username;
          userSession.token = data.token;
          userSession.plan = data.user.plan || 'Free';
          userSession.tracksUsed = data.user.tracksUsed || 0;
          userSession.tracksLimit = data.user.tracksLimit || 3;
          
          updateUserInterface();
          showToast(`¬°Bienvenido de vuelta, ${data.user.username}!`, 'success');
        } else {
          showToast('Credenciales incorrectas', 'error');
        }
      } catch (error) {
        // Mock login for demo
        userSession.isLoggedIn = true;
        userSession.username = email.split('@')[0];
        userSession.token = 'demo_token_' + Math.random().toString(36).substr(2, 9);
        
        updateUserInterface();
        showToast(`¬°Bienvenido, ${userSession.username}!`, 'success');
      }
    }
    
    async function performRegistration(username, email, password, archetype) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password, archetype })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showToast('¬°Registro exitoso! Iniciando sesi√≥n...', 'success');
          await performLogin(email, password);
        } else {
          showToast('Error en el registro: ' + data.message, 'error');
        }
      } catch (error) {
        // Mock registration for demo
        showToast('¬°Registro exitoso! Iniciando sesi√≥n...', 'success');
        setTimeout(() => {
          userSession.isLoggedIn = true;
          userSession.username = username;
          userSession.token = 'demo_token_' + Math.random().toString(36).substr(2, 9);
          
          updateUserInterface();
          showToast(`¬°Bienvenido a la Resistencia, ${username}!`, 'success');
        }, 1000);
      }
    }
    
    function updateUserInterface() {
      const loginBtn = document.getElementById('loginBtn');
      
      if (userSession.isLoggedIn) {
        loginBtn.textContent = userSession.username;
        loginBtn.onclick = showUserMenu;
        loginBtn.classList.remove('btn-primary');
        loginBtn.classList.add('btn-secondary');
      } else {
        loginBtn.textContent = 'Iniciar Sesi√≥n';
        loginBtn.onclick = showLoginModal;
        loginBtn.classList.remove('btn-secondary');
        loginBtn.classList.add('btn-primary');
      }
      
      updateUserStats();
    }
    
    function showUserMenu() {
      const menu = document.createElement('div');
      menu.style.cssText = `
        position: fixed;
        top: 60px;
        right: 20px;
        background: rgba(15, 17, 26, 0.95);
        border: 1px solid rgba(0, 255, 231, 0.3);
        border-radius: 8px;
        padding: 1rem;
        z-index: 9999;
        min-width: 200px;
        box-shadow: 0 0 20px rgba(0, 255, 231, 0.2);
      `;
      
      menu.innerHTML = `
        <div style="color: #00FFE7; font-weight: bold; margin-bottom: 0.5rem;">
          ${userSession.username}
        </div>
        <div style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
          Plan: ${userSession.plan}
        </div>
        <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 0.5rem 0;"></div>
        <button id="profileBtn" class="btn btn-secondary w-full mb-2">Mi Perfil</button>
        <button id="logoutBtn" class="btn btn-secondary w-full">Cerrar Sesi√≥n</button>
      `;
      
      document.body.appendChild(menu);
      
      document.getElementById('logoutBtn').addEventListener('click', () => {
        userSession.isLoggedIn = false;
        userSession.username = null;
        userSession.token = null;
        updateUserInterface();
        menu.remove();
        showToast('Sesi√≥n cerrada', 'info');
      });
      
      document.getElementById('profileBtn').addEventListener('click', () => {
        menu.remove();
        showSection('santuario');
      });
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 100);
    }
    
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => console.log('SW registered'))
        .catch(error => console.log('SW registration failed'));
    }
  </script>
</body>
</html>